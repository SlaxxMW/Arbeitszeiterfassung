<!DOCTYPE html>
<html lang="de">
<head>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Arbeitszeit">
  <link rel="apple-touch-icon" href="icon-192.png">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>Arbeitszeit-Tracker (Team) v15 - Offline</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --accent:#111827;
      --soft:#eef2ff;
      --warn:#f59e0b;
      --bad:#ef4444;
      --good:#16a34a;

      --r:16px;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --shadow2:0 6px 16px rgba(0,0,0,.08);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--text); background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(250,250,250,.92);
      backdrop-filter:saturate(120%) blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 14px 10px;
    }
    .toprow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      max-width:1180px; margin:0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, #3b82f6 0%, #111827 55%, #000 100%);
      box-shadow:var(--shadow2);
      flex:0 0 auto;
    }
    .title{line-height:1.1; min-width:0;}
    .title b{
      display:block; font-size:14px; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:52vw;
    }
    .title span{
      display:block; font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:52vw;
    }
    .actions{display:flex; gap:8px; align-items:center; flex:0 0 auto;}
    button, .btn{
      appearance:none; border:1px solid var(--line);
      background:var(--card);
      color:var(--ink);
      border-radius:14px;
      padding:10px 12px;
      font-weight:750;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 2px 0 rgba(0,0,0,.03);
    }
    button:active{transform:translateY(1px)}
    .btnPrimary{background:var(--accent); border:1px solid rgba(0,0,0,0); color:#fff;}
    .btnSoft{background:var(--soft); border-color:#dbeafe; color:#1e3a8a;}
    .btnDanger{background:var(--danger); border:1px solid rgba(0,0,0,0); color:#fff;}
    .btnOk{background:#ecfdf5; border-color:#bbf7d0; color:#166534;}
    .seg{
      display:flex; gap:8px; padding-top:10px;
      max-width:1180px; margin:0 auto;
      overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .tab{
      white-space:nowrap;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--muted);
      font-weight:800;
      font-size:12.5px;
    }
    .tab.active{
      color:#fff;
      background:linear-gradient(135deg, #111827 0%, #0b1222 100%);
      border-color:transparent;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }
    main{max-width:1180px; margin:0 auto; padding:14px 14px 120px;}
    .grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    @media (min-width: 980px){ .grid.cols2{grid-template-columns: 1.35fr .65fr;} }
    @media (min-width: 980px){ .grid.cols3{grid-template-columns: repeat(3, 1fr);} }
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);}
    .card h2{margin:0 0 10px; font-size:14px; letter-spacing:.2px;}
    .sub{color:var(--muted); font-size:12.5px; margin-top:-6px; margin-bottom:10px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;}
    .field{display:flex; flex-direction:column; gap:6px; min-width: 140px; flex:1 1 160px;}
    .field label{font-size:12px; color:var(--muted); font-weight:800;}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:#fbfbfb; color:var(--ink);
      font-size:13px; outline:none;
    }
    textarea{min-height:44px; resize:vertical}
    .kpis{
      display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;
    }
    @media(min-width:980px){ .kpis{grid-template-columns: repeat(4, 1fr);} }
    .kpi{
      border-radius:16px; border:1px solid var(--line);
      background:linear-gradient(180deg, #ffffff 0%, #fbfbfb 100%);
      padding:12px;
    }
    .kpi .k{color:var(--muted); font-size:12px; font-weight:800;}
    .kpi .v{margin-top:4px; font-size:18px; font-weight:900; letter-spacing:.2px;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line); background:#fff;
      font-size:12px; color:var(--muted); font-weight:800;
    }
    .pill b{color:var(--ink)}
    .ok{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .right{text-align:right}
    .mono{font-variant-numeric: tabular-nums;}
    .hr{height:1px; background:var(--line); margin:12px 0}
    .tiny{font-size:12px; color:var(--muted); line-height:1.35;}
    .note{
      border-left:4px solid #c7d2fe;
      background:#eef2ff;
      padding:10px 12px;
      border-radius:14px;
      color:#1e3a8a;
      font-size:12.5px;
      font-weight:700;
    }
    .footerBar{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 14px calc(10px + env(safe-area-inset-bottom));
      background:rgba(250,250,250,.92);
      backdrop-filter:saturate(120%) blur(10px);
      border-top:1px solid var(--line);
    }
    .footerInner{
      max-width:1180px; margin:0 auto;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .chip{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line); background:#fff;
      font-size:12px; color:var(--muted); font-weight:850;
    }
    .dangerText{color:var(--bad); font-weight:900}
    .successText{color:var(--good); font-weight:900}
    .hide{display:none!important}

    table{
      width:100%; border-collapse:separate; border-spacing:0;
      overflow:hidden; border-radius:14px; border:1px solid var(--line);
      background:#fff;
    }
    thead th{
      background:#f8fafc; color:#334155; text-align:left;
      font-size:12px; padding:10px; border-bottom:1px solid var(--line);
      position:sticky; top:0;
      z-index:1;
    }
    tbody td{
      padding:10px; font-size:13px; border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none}
    .miniBtns{display:flex; gap:6px; flex-wrap:wrap}
    .miniBtns button{padding:8px 10px; font-size:12px}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 8px; border-radius:999px;
      border:1px solid var(--line); background:#fff;
      font-size:12px; font-weight:900; color:#334155;
    }
    .badgeWork{background:#eef2ff; border-color:#c7d2fe; color:#1e3a8a;}
    .badgeUrlaub{background:#ecfeff; border-color:#a5f3fc; color:#155e75;}
    .badgeKrank{background:#fff7ed; border-color:#fed7aa; color:#9a3412;}
    .badgeHoliday{background:#f0fdf4; border-color:#bbf7d0; color:#166534;}
    .badgeSonst{background:#fdf2f8; border-color:#fbcfe8; color:#9d174d;}
  
button{border-radius:12px;}
button:hover{filter:brightness(0.98);}
.nav button.active{background:var(--accent); color:#fff; border-color:rgba(0,0,0,0);}
.badgeHoliday{background:#dbeafe; border-color:#93c5fd; color:#1e3a8a;}
.badgeUrlaub{background:#dcfce7; border-color:#86efac; color:#14532d;}
.badgeKrank{background:#fee2e2; border-color:#fecaca; color:#7f1d1d;}
.note{background:var(--chip); border:1px dashed var(--border); border-radius:14px; padding:10px 12px; color:var(--muted);}


/* --- v10 Layout (mobile-first) --- */
header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(180%) blur(12px);background:rgba(248,250,252,.92);border-bottom:1px solid var(--border);}
header .toprow{padding:10px 12px;}
header .seg{padding:10px 12px;}

#tabs{position:fixed;left:0;right:0;bottom:0;z-index:60;background:rgba(248,250,252,.96);border-top:1px solid var(--border);padding:10px 12px;display:flex;gap:8px;justify-content:space-between;}
#tabs button{flex:1;border-radius:14px;padding:10px 10px;font-weight:700}
main{padding-bottom:84px;} /* room for bottom tabs */

.footerBar{display:none !important;}

.kpiGrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;}
@media (max-width: 860px){
  .kpiGrid{grid-template-columns:repeat(2,minmax(0,1fr));}
}

/* Timesheet: card list on mobile */
.dayCards{display:none;}
@media (max-width: 860px){
  table{font-size:13px}
  .tableWrap{display:none;}
  .dayCards{display:block;}
  .dayCard{border:1px solid var(--border);background:var(--card);border-radius:16px;padding:12px;margin:10px 0;box-shadow:var(--shadow);}
  .dayTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
  .dayDate{font-weight:800}
  .dayMeta{color:var(--muted);font-size:12px;margin-top:2px}
  .dayHours{font-weight:900;font-size:18px}
  .dayHours.negative{color:var(--danger);}
  .dayHours.positive{color:var(--accent2);}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:12px;color:var(--muted);margin-top:6px}
  .rowCompact{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .btnRow{display:flex;gap:8px;margin-top:10px}
}

/* Hide any accidental inline code/text blocks if a browser renders script as text (safety) */
script{display:none !important;}


/* v11 UI clarity */
.totalsStrip{
  display:grid;
  grid-template-columns: repeat(4, minmax(120px, 1fr));
  gap:10px;
  margin: 10px 0 14px;
}
@media (max-width: 700px){
  .totalsStrip{ grid-template-columns: repeat(2, minmax(140px, 1fr)); }
}
.totCard{
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75));
}
.totCard .lbl{ font-size:12px; color:var(--muted); }
.totCard .val{ font-size:16px; font-weight:800; margin-top:4px; }
.totCard.ok{ border-color: rgba(22,163,74,0.35); }
.totCard.ok .val{ color: var(--accent2); }
.totCard.bad{ border-color: rgba(220,38,38,0.35); }
.totCard.bad .val{ color: var(--danger); }
.totCard.neutral .val{ color: var(--text); }
.totCard.small .val{ font-size:14px; font-weight:700; }


/* v12: Monats-Layout + Zeitraum-Modal */
.modalCard{background:var(--card); border:1px solid var(--border); border-radius:18px; padding:14px; box-shadow:var(--shadow); max-width:780px; width:min(780px, calc(100vw - 26px));}
.modalHead{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
.modalTitle{font-size:18px; font-weight:900;}
.modalSub{color:var(--muted); font-size:13px; margin-top:2px;}
.iconBtn{border:1px solid var(--border); background:var(--chip); width:38px; height:38px; border-radius:12px;}
.iconBtn:hover{filter:brightness(0.98);}

.monthWrap{margin-top:10px;}
.monthKpis{display:grid; grid-template-columns:repeat(5, minmax(120px, 1fr)); gap:10px; margin-top:10px;}
@media (max-width: 900px){ .monthKpis{grid-template-columns:repeat(2, minmax(140px, 1fr));} }
.kpi{border:1px solid var(--border); border-radius:14px; padding:10px 12px; background:rgba(255,255,255,0.92);}
.kpi .k{font-size:12px; color:var(--muted);}
.kpi .v{font-weight:900; font-size:16px; margin-top:4px;}
.kpi.pos .v{color:var(--accent2);}
.kpi.neg .v{color:var(--danger);}

.dayCards{margin-top:12px;}
.dayCard{
  border:1px solid var(--border); border-radius:16px; padding:12px;
  background:rgba(255,255,255,0.92); margin-top:10px;
}
.dayCard .dTop{display:flex; justify-content:space-between; gap:10px; align-items:baseline; flex-wrap:wrap;}
.dayCard .dTitle{font-weight:900;}
.dayCard .dMeta{color:var(--muted); font-size:12px;}
.dayCard .dRight{font-weight:900;}
.dayCard .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--chip); font-size:12px;}
.dayCard .actions{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;}
.dayCard .actions button{padding:8px 10px;}
.dayCard:hover{border-color: rgba(37,99,235,0.35);}
</style>
</head>

<body>
<header>
  <div class="toprow">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div class="title">
        <b>Arbeitszeit-Tracker (Team) v15</b>
        <span>Offline - lokal gespeichert - Urlaub/Krank/Feiertage reduzieren Soll - Export als Excel/CSV</span>
      </div>
    </div>
    <div class="actions">
      <button class="btnSoft" id="btnQuickToday">+ Heute</button>
      <button class="btnPrimary" id="btnExportNow">Export</button>
    </div>
  </div>
  <div class="seg" id="tabs"></div>
</header>

<main>
  <!-- Dashboard -->
  <section id="view_dashboard" class="view">
    <div class="grid cols2">
      <div class="card">
        <h2>Live-Ueberblick</h2>
        <div class="sub">Tag - Woche - Monat - Jahr - Ueber/Minus - Urlaubrest (Feiertage/Abwesenheit reduzieren Soll automatisch)</div>

        <div class="row" style="margin-bottom:10px">
          <div class="field" style="min-width:260px; flex: 1 1 260px;">
            <label>Person</label>
            <select id="selPerson"></select>
          </div>
          <div class="field">
            <label>Zeitraum</label>
            <select id="selScope">
              <option value="day">Heute</option>
              <option value="week" selected>Diese Woche</option>
              <option value="month">Dieser Monat</option>
              <option value="year">Dieses Jahr</option>
              <option value="custom">Benutzerdefiniert</option>
            </select>
          </div>
          <div class="field" id="customRange" style="display:none">
            <label>Von</label>
            <input type="date" id="fromDate">
          </div>
          <div class="field" id="customRange2" style="display:none">
            <label>Bis</label>
            <input type="date" id="toDate">
          </div>
        </div>

        <div class="kpis" id="kpis"></div>

        <div class="hr"></div>

        <div class="row">
          <div class="pill"><span>Soll/Tag:</span> <b class="mono" id="kpiSollDay">-</b></div>
          <div class="pill"><span>Soll/Woche:</span> <b class="mono" id="kpiSollWeek">-</b></div>
          <div class="pill"><span>Arbeitstage/Woche:</span> <b class="mono" id="kpiWorkdays">-</b></div>
          <div class="pill"><span>Feiertage (Jahr):</span> <b class="mono" id="kpiHolidayCountYear">-</b></div>
        </div>

        <div class="hr"></div>

        <div class="note">
          Tipp: Als App nutzen via "Zum Home-Bildschirm" (iPhone) oder "App installieren" (Android).
          Backup (JSON) 1x pro Woche, dann geht nichts verloren.
        </div>
      </div>

      <div class="card">
        <h2>Schnell-Eingabe</h2>
      <div id="quickTotals" class="totalsStrip"></div>
        <div class="sub">Arbeit eintragen (auch rueckwirkend) - oder Abwesenheit</div>

        <div class="row">
          <div class="field">
            <label>Datum</label>
            <input type="date" id="inDate">
          </div>
          <div class="field">
            <label>Start</label>
            <input type="time" id="inStart" value="07:00">
          </div>
          <div class="field">
            <label>Ende</label>
            <input type="time" id="inEnd" value="16:00">
          </div>
          <div class="field">
            <label>Pause (Min.)</label>
            <input type="number" id="inBreak" min="0" step="5" value="30">
          </div>
        </div>

        <div class="row">
          <div class="field" style="flex:1 1 280px">
            <label>Notiz (optional)</label>
            <input type="text" id="inNote" placeholder="z.B. Baustelle, Kunde, ...">
          </div>
        </div>

        <div class="row">
          <button class="btnPrimary" id="btnAddEntry">Eintrag speichern</button>
          <button id="btnAddAbsence">Urlaub/Krank/Feiertag</button>
            <button id="btnAbsenceRange">Zeitraum setzen</button>
        </div>

        <div class="hr"></div>

        <div class="tiny">
          Standard-Eckdaten (aenderbar): <b>30 Tage Urlaub</b>, <b>40h/Woche</b>, <b>5 Tage/Woche</b> (= 8h/Tag).
          Urlaub/Krank/Feiertage reduzieren Soll automatisch nur an Arbeitstagen.
        </div>
      </div>
    </div>
  </section>

  <!-- Uebersichten -->
  <section id="view_overview" class="view hide">
    <div class="card">
      <h2>Uebersichten</h2>
      <div class="sub">Woche - Monat - Jahr (mit Tageswerten und Jahreswerten)</div>

      <div class="row">
        <div class="field" style="min-width:260px">
          <label>Person</label>
          <select id="selPersonO"></select>
        </div>
        <div class="field">
          <label>Modus</label>
          <select id="ovMode">
            <option value="week">Woche</option>
            <option value="month" selected>Monat</option>
            <option value="year">Jahr</option>
          </select>
        </div>
        <div class="field" id="ovPickDateWrap">
          <label>Referenz-Datum</label>
          <input type="date" id="ovPickDate">
        </div>
        <div class="field" id="ovPickMonthWrap" style="display:none">
          <label>Monat</label>
          <select id="ovPickMonth"></select>
        </div>
        <div class="field" id="ovPickYearWrap">
          <label>Jahr</label>
          <select id="ovPickYear"></select>
        </div>
        <div class="field" style="min-width:210px">
          <label>Nur Arbeitstage anzeigen</label>
          <select id="ovOnlyWorkdays">
            <option value="no" selected>Nein</option>
            <option value="yes">Ja</option>
          </select>
        </div>
        <div class="field" style="min-width:210px">
          <label>Download</label>
          <div class="row" style="gap:8px">
            <button class="btnPrimary" id="btnOvXls">Excel (XLS)</button>
            <button id="btnOvCsv">CSV</button>
            <button class="btnSoft" id="btnOvPrint">PDF/Print</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="kpis" id="ovKpis"></div>

      <div class="hr"></div>

      <div style="overflow:auto; max-height:62vh;">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Tag</th>
              <th>Typ</th>
              <th>Start-Ende</th>
              <th class="right">Pause</th>
              <th class="right">Ist</th>
              <th class="right">Soll</th>
              <th class="right">Diff</th>
              <th>Notiz</th>
            </tr>
          </thead>
          <tbody id="ovTable"></tbody>
        </table>
      </div>

      <div class="hr"></div>
      <div class="tiny">
        Logik: <b>Soll</b> wird nur an Arbeitstagen gerechnet. Urlaub/Krank/Feiertag reduzieren Soll automatisch.
        Wenn ihr an einem Urlaubstag trotzdem arbeitet: einfach Arbeits-Eintrag setzen - das zaehlt als Ist-Stunden.
      </div>
    </div>
  </section>

  <!-- Timesheet -->
  <section id="view_timesheet" class="view hide">
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
  <h2 style="margin:0">Eintraege (editieren/loeschen)</h2>
  <button id="btnAbsenceRangeTS">Zeitraum setzen</button>
</div>
      <div class="sub">Monats-Ansicht (mobil) + Tabelle (Desktop). Klick auf einen Tag zum Bearbeiten.</div>
      <div id="monthHeader" class="note" style="margin-top:10px"></div>
      <div id="dayCards" class="dayCards"></div>

      <div class="row">
        <div class="field" style="min-width:260px">
          <label>Person</label>
          <select id="selPerson2"></select>
        </div>
        <div class="field">
          <label>Filter (Jahr)</label>
          <select id="selYear"></select>
        </div>
        <div class="field">
          <label>Monat</label>
          <select id="selMonth2">
            <option value="">Alle</option>
            <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mrz</option><option value="04">Apr</option>
            <option value="05">Mai</option><option value="06">Jun</option><option value="07">Jul</option><option value="08">Aug</option>
            <option value="09">Sep</option><option value="10">Okt</option><option value="11">Nov</option><option value="12">Dez</option>
          </select>
        </div>
        <div class="field">
          <label>Suche (Notiz)</label>
          <input id="searchNote" placeholder="z.B. Baustelle, Kunde..." />
        </div>
      </div>

      <div class="hr"></div>

      <div style="overflow:auto; max-height:62vh;">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Typ</th>
              <th>Start-Ende</th>
              <th class="right">Pause</th>
              <th class="right">Stunden</th>
              <th>Notiz</th>
              <th class="right">Aktion</th>
            </tr>
          </thead>
          <tbody id="tblEntries"></tbody>
        </table></div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="pill"><span>Summe Jahr:</span> <b class="mono" id="sumYear">-</b></div>
        <div class="pill"><span>Summe Monat:</span> <b class="mono" id="sumMonth">-</b></div>
        <div class="pill"><span>Summe Woche:</span> <b class="mono" id="sumWeek">-</b></div>
      </div>
    </div>
  </section>

  <!-- Urlaub -->
  <section id="view_urlaub" class="view hide">
    <div class="grid cols2">
      <div class="card">
        <h2>Urlaub & Abwesenheiten</h2>
        <div class="sub">Urlaubtage - Resturlaub - Krank - Feiertage (reduzieren Soll an Arbeitstagen)</div>

        <div class="row">
          <div class="field" style="min-width:260px">
            <label>Person</label>
            <select id="selPerson3"></select>
          </div>
          <div class="field">
            <label>Jahr</label>
            <select id="selYear2"></select>
          </div>
        </div>

        <div class="kpis" id="kpisVacation"></div>

        <div class="hr"></div>

        <div class="tiny">
          Hinweis: Urlaub/Krank werden nur an <b>Arbeitstagen</b> als reduzierte Solltage gezaehlt.
          Feiertage verwaltet ihr in den Einstellungen als Liste (Datum + Name).
        </div>
      </div>

      <div class="card">
        <h2>Abwesenheit eintragen</h2>
        <div class="sub">Start/Ende + Typ + optionaler Kommentar</div>

        <div class="row">
          <div class="field">
            <label>Von</label>
            <input type="date" id="absFrom">
          </div>
          <div class="field">
            <label>Bis</label>
            <input type="date" id="absTo">
          </div>
          <div class="field">
            <label>Typ</label>
            <select id="absType">
              <option value="urlaub">Urlaub</option>
              <option value="krank">Krank</option>
              <option value="sonst">Sonstiges</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field" style="flex:1 1 280px">
            <label>Kommentar (optional)</label>
            <input type="text" id="absNote" placeholder="z.B. Arzt, Kind krank, ...">
          </div>
        </div>

        <div class="row">
          <button class="btnPrimary" id="btnSaveAbs">Speichern</button>
          <button class="btnDanger" id="btnClearAbs">Zuruecksetzen</button>
        </div>
      </div>
    </div>
  </section>

  
  <!-- Feiertage Auto -->
  <section id="view_holidays_auto" class="view hide">
    <div class="grid cols2">
      <div class="card">
        <h2>Automatische Feiertage (Deutschland)</h2>
        <div class="sub">Bundesland waehlen - Jahr(e) auswaehlen - Klick: Feiertage automatisch eintragen. (Offline, ohne Internet)</div>

        <div class="row">
          <div class="field" style="min-width:240px">
            <label>Bundesland</label>
            <select id="autoHolState">
              <option value="BY" selected>Bayern (BY)</option>
              <option value="BW">Baden-Wuerttemberg (BW)</option>
              <option value="BE">Berlin (BE)</option>
              <option value="BB">Brandenburg (BB)</option>
              <option value="HB">Bremen (HB)</option>
              <option value="HH">Hamburg (HH)</option>
              <option value="HE">Hessen (HE)</option>
              <option value="MV">Mecklenburg-Vorpommern (MV)</option>
              <option value="NI">Niedersachsen (NI)</option>
              <option value="NW">Nordrhein-Westfalen (NW)</option>
              <option value="RP">Rheinland-Pfalz (RP)</option>
              <option value="SL">Saarland (SL)</option>
              <option value="SN">Sachsen (SN)</option>
              <option value="ST">Sachsen-Anhalt (ST)</option>
              <option value="SH">Schleswig-Holstein (SH)</option>
              <option value="TH">Thueringen (TH)</option>
            </select>
          </div>

          <div class="field">
            <label>Von Jahr</label>
            <select id="autoHolFromYear"></select>
          </div>
          <div class="field">
            <label>Bis Jahr</label>
            <select id="autoHolToYear"></select>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Optionen (regionale Sonderfaelle)</h2>
        <div class="sub">Nur nutzen, wenn es bei euch wirklich gilt.</div>

        <div class="row">
          <div class="field" style="min-width:260px; flex: 1 1 260px;">
            <label>Bayern: Mariae Himmelfahrt (15. Aug)</label>
            <select id="optAssumptionBY">
              <option value="on" selected>Eintragen (typisch, aber nicht ueberall in BY)</option>
              <option value="off">Nicht eintragen</option>
            </select>
          </div>

          <div class="field" style="min-width:260px; flex: 1 1 260px;">
            <label>Bayern: Augsburger Friedensfest (8. Aug, nur Augsburg)</label>
            <select id="optPeaceAugsburg">
              <option value="off" selected>Aus</option>
              <option value="on">Eintragen (nur Stadt Augsburg)</option>
            </select>
          </div>

          <div class="field" style="min-width:260px; flex: 1 1 260px;">
            <label>SN/TH: Fronleichnam (nur wenige Regionen)</label>
            <select id="optCorpusPartial">
              <option value="off" selected>Aus</option>
              <option value="on">Eintragen (wenn es bei euch gilt)</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btnPrimary" id="btnAutoHolidaysApply">Feiertage automatisch eintragen / aktualisieren</button>
          <button id="btnAutoHolidaysPreview">Vorschau anzeigen</button>
          <button class="btnDanger" id="btnAutoHolidaysClear">Auto-Feiertage fuer Jahr(e) entfernen</button>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Vorschau</label>
          <textarea id="autoHolPreview" readonly></textarea>
        </div>

        <div class="tiny">
          Wie es wirkt: Feiertage werden in den Einstellungen unter "Feiertage" gespeichert und reduzieren automatisch das Soll (nur an Arbeitstagen).
          Du kannst jederzeit manuell einzelne Feiertage dazu-/wegnehmen.
        </div>
      </div>

      <div class="card">
        <h2>Was wird automatisch eingetragen?</h2>
        <div class="sub">Abhaengig vom Bundesland. Enthalten sind u.a. die bundesweiten Feiertage + landesspezifische (z.B. 6. Jan, 8. Mar, 31. Okt, 1. Nov, Buß- und Bettag, Weltkindertag, Fronleichnam, usw.).</div>

        <div class="note">
          Wichtig: Manche Feiertage sind <b>nicht in jedem Ort</b> gleich (z.B. Mariae Himmelfahrt in Bayern oder Fronleichnam in wenigen Regionen in SN/TH).
          Darum gibt es oben die Optionen als Schalter.
        </div>

        <div class="hr"></div>

        <div class="tiny">
          Wenn du willst, kann ich als naechstes noch einbauen:
          - Export fuer <b>alle Personen auf einmal</b> (ein Excel pro Jahr mit Tabs je Person)
          - Team-Sync per einfachem JSON in WhatsApp (jeder importiert denselben Stand)
        </div>
      </div>
    </div>
  </section>


  <!-- Einstellungen -->
  <section id="view_settings" class="view hide">
    <div class="grid cols2">
      <div class="card">
        <h2>Einstellungen</h2>
        <div class="sub">Eckdaten + Team + Feiertage</div>

        <div class="row">
          <div class="field">
            <label>Arbeitstage/Woche</label>
            <select id="cfgWorkdays">
              <option>4</option>
              <option selected>5</option>
              <option>6</option>
            </select>
          </div>
          <div class="field">
            <label>Sollstunden/Woche</label>
            <input type="number" id="cfgWeeklyHours" min="1" step="0.5" value="40">
          </div>
          <div class="field">
            <label>Urlaubstage/Jahr</label>
            <input type="number" id="cfgVacationDays" min="0" step="1" value="30">
          </div>
        </div>

        <div class="hr"></div>

        <h2>Team</h2>
        <div class="sub">Personen verwalten (alles bleibt lokal auf dem Geraet)</div>

        <div class="row">
          <div class="field" style="flex:1 1 260px">
            <label>Neuer Name</label>
            <input type="text" id="newPersonName" placeholder="z.B. Max, Lisa, ...">
          </div>
          <button class="btnPrimary" id="btnAddPerson">Hinzufuegen</button>
        </div>

        <div class="hr"></div>
        <div id="peopleList"></div>

        <div class="hr"></div>

        <h2>Feiertage</h2>
        <div class="sub">Liste pro Jahr (Datum + Name). Feiertage reduzieren Soll an Arbeitstagen.</div>

        <div class="row">
          <div class="field" style="min-width:140px">
            <label>Jahr</label>
            <select id="holYear"></select>
          </div>
          <div class="field">
            <label>Datum</label>
            <input type="date" id="holDate">
          </div>
          <div class="field" style="flex:1 1 240px">
            <label>Name</label>
            <input type="text" id="holName" placeholder="z.B. Neujahr">
          </div>
          <button class="btnOk" id="btnAddHoliday">Feiertag hinzufuegen</button>
        </div>

        <div class="hr"></div>

        <div style="overflow:auto; max-height:240px;">
          <table>
            <thead>
              <tr><th>Datum</th><th>Name</th><th class="right">Aktion</th></tr>
            </thead>
            <tbody id="holTable"></tbody>
          </table>
        </div>

      </div>

      <div class="card">
        <h2>Backup & Restore</h2>
        <div class="hr"></div>

        <h2>CSV Import (Jahres-/Monatswerte)</h2>
        <div class="sub">Importiert Summen (Monat/Jahr) aus einer CSV wie "Stundenuebersicht eines Jahres ...". Namen sind editierbar.</div>

        <div class="row">
          <div class="field" style="flex:1 1 280px">
            <label>CSV Datei(en)</label>
            <input type="file" id="csvImportFile" accept=".csv,text/csv" multiple>
          </div>
        </div>

        <div class="row">
          <div class="field" style="min-width:260px; flex:1 1 260px;">
            <label>Name (wird automatisch erkannt, aber editierbar)</label>
            <input type="text" id="csvImpName" placeholder="z.B. Markus Wolf">
          </div>
          <div class="field" style="min-width:160px">
            <label>Jahr</label>
            <input type="number" id="csvImpYear" min="2000" max="2100" step="1">
          </div>
          <div class="field" style="min-width:260px">
            <label>Import in Person</label>
            <select id="csvImpPersonTarget">
              <option value="auto" selected>Auto: Name verwenden (Person anlegen, wenn noetig)</option>
            </select>
          </div>
        </div>

        <div class="row">
          <button class="btnPrimary" id="btnCsvImportApply">CSV uebernehmen</button>
          <button id="btnCsvImportPreview">Vorschau</button>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Import-Vorschau</label>
          <textarea id="csvImpPreview" readonly></textarea>
        </div>

        <div class="tiny">
          Hinweis: CSV-Import kann keine Tageszeiten rekonstruieren Daher sind <b>Monat/Jahr</b> sofort korrekt,
          <b>Tag/Woche</b> nur, wenn du zusaetzlich Tages-Eintraege erfasst.
        </div>

        <div class="sub">JSON Export/Import (komplettes Backup)</div>

        <div class="row">
          <button id="btnBackup" class="btnPrimary">Backup (JSON) downloaden</button>
          <button id="btnResetAll" class="btnDanger">Alles zuruecksetzen</button>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Backup importieren (JSON)</label>
          <input type="file" id="importFile" accept="application/json">
        </div>

        <div class="hr"></div>

        <div class="note">
          Profi-Tipp: Speichert euer Backup z.B. einmal pro Woche in WhatsApp/Drive/Files.
        </div>
      </div>
    </div>
  </section>

  <!-- Export -->
  <section id="view_export" class="view hide">
    <div class="grid cols2">
      <div class="card">
        <h2>Export / Download</h2>
        <div class="sub">Excel (XLS) + CSV + Bericht (TXT) + PDF/Print</div>

        <div class="row">
          <div class="field" style="min-width:260px">
            <label>Person</label>
            <select id="selPerson4"></select>
          </div>
          <div class="field">
            <label>Jahr</label>
            <select id="selYear3"></select>
          </div>
<div class="field">
            <label>Monat (optional)</label>
            <select id="selMonth">
              <option value="">Ganzes Jahr</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btnPrimary" id="btnXls">Excel (XLS) downloaden</button>
          <button id="btnCsv">CSV downloaden</button>
          <button id="btnReportTxt">Bericht (TXT) downloaden</button>
          <button class="btnSoft" id="btnPrint">PDF/Print</button>
        </div>

        <div class="hr"></div>

        <div class="tiny">
          "Excel (XLS)" ist ein Excel-kompatibles Format (XML Spreadsheet), funktioniert offline ohne externe Bibliotheken.
          Dateiname enthaelt automatisch den <b>Namen</b> + Zeitraum.
        </div>
      </div>

      <div class="card">
        <h2>WhatsApp senden</h2>
        <div class="sub">Kurzbericht als Text teilen (oder Datei ueber Share-Sheet)</div>

        <div class="row">
          <button class="btnPrimary" id="btnShare">Teilen (Share)</button>
          <button id="btnWhatsApp">WhatsApp Text</button>
        </div>

        <div class="hr"></div>

        <div class="field">
          <label>Vorschau Text</label>
          <textarea id="sharePreview" readonly></textarea>
        </div>

        <div class="tiny">
          Hinweis: "Teilen" versucht, eine Datei zu teilen (wenn das Geraet es kann).
          "WhatsApp Text" oeffnet WhatsApp mit fertigem Text (kein Datei-Anhang).
        </div>
      </div>
    </div>
  </section>
</main>

<div class="footerBar">
  <div class="footerInner">
    <div class="row" style="align-items:center">
      <span class="chip">Status: <span id="chipStatus" class="successText">OK</span></span>
      <span class="chip">Letzter Export: <span id="chipLastExport">-</span></span>
    </div>
    <div class="row">
      <button class="btnSoft" id="btnGoOverview">Uebersicht</button>
      <button class="btnPrimary" id="btnGoTimesheet">Eintraege</button>
    </div>
  </div>
</div>


<!-- Modals -->
<div id="modalBackdrop" class="hide" style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9998;"></div>

<div id="nameSetupModal" class="hide" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;max-width:560px;width:calc(100% - 24px);">
  <div class="card" style="box-shadow:0 20px 60px rgba(0,0,0,.28);">
    <h2>Dein Name</h2>
    <div class="sub">Damit bei dir nicht "Ich" steht. Jeder Kollege kann das auf seinem Handy einmalig setzen.</div>
    <div class="row">
      <div class="field" style="flex:1 1 260px">
        <label>Name</label>
        <input id="myNameInput" placeholder="z.B. Markus" />
      </div>
    </div>
    <div class="row">
      <button class="btnPrimary" id="btnSaveMyName">Speichern</button>
      <button id="btnSkipMyName">Spaeter</button>
    </div>
  </div>
</div>

<div id="dayEditModal" class="hide" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:9999;max-width:760px;width:calc(100% - 24px);">
  <div class="card" style="box-shadow:0 20px 60px rgba(0,0,0,.28);">
    <div class="row" style="align-items:center; justify-content:space-between;">
      <div>
        <h2 style="margin-bottom:2px;">Tag bearbeiten</h2>
        <div class="sub" id="dayEditSubtitle">-</div>
      </div>
      <button class="btnDanger" id="btnDayEditClose">Schliessen</button>
    </div>

    <div class="row">
      <div class="field" style="min-width:240px">
        <label>Typ</label>
        <select id="dayEditType">
          <option value="work">Arbeit</option>
          <option value="urlaub">Urlaub (auto 8h)</option>
          <option value="krank">Krank (auto 8h)</option>
          <option value="holiday">Feiertag (auto 8h)</option>
          <option value="sonst">Sonst (Soll=0)</option>
          <option value="none">Leer (nichts)</option>
        </select>
      </div>
      <div class="field" style="min-width:240px" id="dayEditHolidayNameWrap" style="display:none">
        <label>Feiertag-Name</label>
        <input id="dayEditHolidayName" placeholder="z.B. Neujahr" />
      </div>
      <div class="field" style="min-width:240px" id="dayEditWorkPickWrap">
        <label>Arbeits-Eintrag (falls mehrere)</label>
        <select id="dayEditWorkPick"></select>
      </div>
    </div>

    <div id="dayEditWorkFields">
      <div class="row">
        <div class="field">
          <label>Start</label>
          <input type="time" id="dayEditStart" value="07:00" />
        </div>
        <div class="field">
          <label>Ende</label>
          <input type="time" id="dayEditEnd" value="16:00" />
        </div>
        <div class="field">
          <label>Pause (Min.)</label>
          <input type="number" id="dayEditBreak" min="0" step="5" value="30" />
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 320px">
          <label>Notiz</label>
          <input id="dayEditNote" placeholder="optional" />
        </div>
      </div>

      <div class="row">
        <button class="btnPrimary" id="btnDayEditSaveWork">Speichern</button>
        <button id="btnDayEditAddWork">+ Neuer Arbeits-Eintrag</button>
        <button class="btnDanger" id="btnDayEditDeleteWork">Arbeits-Eintrag loeschen</button>
      </div>
    </div>

    <div id="dayEditAbsenceFields" class="hide">
      <div class="tiny" style="margin-top:6px">
        Urlaub/Krank/Feiertag werden automatisch als <b>8h</b> (bzw. Soll/Tag) gutgeschrieben, wenn es ein Arbeitstag ist.
        "Sonst" reduziert Soll auf 0.
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btnPrimary" id="btnDayEditSaveAbs">Speichern</button>
        <button class="btnDanger" id="btnDayEditClearDay">Tag leeren</button>
      </div>
    </div>

  </div>
</div>

<script>
(() => {
  "use strict";

  const APP_KEY = "azTeamTracker_v2";

  const $ = (id) => document.getElementById(id);
  const todayISO = () => new Date().toISOString().slice(0,10);

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function parseTimeToMinutes(t){
    if(!t) return null;
    const parts = t.split(":").map(Number);
    if(parts.length < 2) return null;
    const hh = parts[0], mm = parts[1];
    if(Number.isNaN(hh) || Number.isNaN(mm)) return null;
    return hh*60 + mm;
  }
  function minutesToHHMM(m){
    const hh = Math.floor(m/60);
    const mm = Math.round(m%60);
    return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
  }
  function dateToTs(d){ return new Date(d+"T00:00:00").getTime(); }

  function startOfWeekISO(dateISO){
    const d = new Date(dateISO+"T00:00:00");
    const day = (d.getDay() + 6) % 7; // Mo=0
    d.setDate(d.getDate() - day);
    return d.toISOString().slice(0,10);
  }
  function endOfWeekISO(dateISO){
    const d = new Date(startOfWeekISO(dateISO)+"T00:00:00");
    d.setDate(d.getDate() + 6);
    return d.toISOString().slice(0,10);
  }
  function startOfMonthISO(dateISO){
    const d = new Date(dateISO+"T00:00:00");
    d.setDate(1);
    return d.toISOString().slice(0,10);
  }
  function endOfMonthISO(dateISO){
    const d = new Date(dateISO+"T00:00:00");
    d.setMonth(d.getMonth()+1, 0);
    return d.toISOString().slice(0,10);
  }
  function startOfYearISO(year){ return `${year}-01-01`; }
  function endOfYearISO(year){ return `${year}-12-31`; }

  function eachDay(fromISO, toISO, cb){
    let d = new Date(fromISO+"T00:00:00");
    const end = new Date(toISO+"T00:00:00");
    while(d.getTime() <= end.getTime()){
      cb(d.toISOString().slice(0,10));
      d.setDate(d.getDate()+1);
    }
  }
  function listDaysInRange(fromISO, toISO){
    const out=[];
    const d0 = new Date(fromISO+"T00:00:00");
    const d1 = new Date(toISO+"T00:00:00");
    for(let d=new Date(d0); d<=d1; d.setDate(d.getDate()+1)){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      out.push(`${y}-${m}-${da}`);
    }
    return out;
  }
  function weekdayName(iso){
    const d = new Date(iso+"T00:00:00");
    return ["So","Mo","Di","Mi","Do","Fr","Sa"][d.getDay()];
  }
  function fmtDateDE(iso){
    // dd.mm.yyyy
    return `${iso.slice(8,10)}.${iso.slice(5,7)}.${iso.slice(0,4)}`;
  }


  function defaultState(){
    return {
      version: 2,
      cfg: { workdaysPerWeek: 5, weeklyHours: 40, vacationDaysPerYear: 30, holidayState: "BY", holidayOptAssumptionBY: true, holidayOptPeaceAugsburg: false, holidayOptCorpusPartial: false },
      people: [{ id: crypto.randomUUID(), name: "Ich" }],
      entries: [],
      aggregates: {},
      carry: {},
      holidays: {
        // year: [{dateISO, name}]
      },
      ui: { activePersonId: null, lastExportISO: "" },
      createdAt: new Date().toISOString()
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(APP_KEY);
      if(!raw) return defaultState();
      const s = JSON.parse(raw);
      if(!s || typeof s !== "object") return defaultState();
      if(!s.cfg) s.cfg = defaultState().cfg;
      if(!Array.isArray(s.people) || s.people.length===0) s.people = defaultState().people;
      if(!Array.isArray(s.entries)) s.entries = [];
      if(!s.aggregates || typeof s.aggregates !== "object") s.aggregates = {};
      if(!s.carry || typeof s.carry !== "object") s.carry = {};
      if(!s.holidays) s.holidays = {};
      if(!s.ui) s.ui = { activePersonId: s.people[0]?.id || null, lastExportISO: "" };
      if(!s.ui.activePersonId) s.ui.activePersonId = s.people[0]?.id || null;

      // normalize new cfg fields
      if(!s.cfg.holidayState) s.cfg.holidayState = "BY";
      if(typeof s.cfg.holidayOptAssumptionBY !== "boolean") s.cfg.holidayOptAssumptionBY = true;
      if(typeof s.cfg.holidayOptPeaceAugsburg !== "boolean") s.cfg.holidayOptPeaceAugsburg = false;
      if(typeof s.cfg.holidayOptCorpusPartial !== "boolean") s.cfg.holidayOptCorpusPartial = false;
      return s;
    }catch(e){
      console.warn("loadState error", e);
      return defaultState();
    }
  }
  
  // -----------------------------
  // v14: UI-Prefs (merken pro Gerät)
  // -----------------------------
  function getUi(){ state.ui = state.ui || {}; return state.ui; }
  function saveUiPrefs(patch){
    const ui = getUi();
    Object.assign(ui, patch || {});
    saveState();
  }
function saveState(){
    localStorage.setItem(APP_KEY, JSON.stringify(state));
    setStatus("OK", true);
  }
  function setStatus(text, ok){
    $("chipStatus").textContent = text;
    $("chipStatus").className = ok ? "successText" : "dangerText";
  }

  let state = loadState();

  const TAB_DEF = [
    ["dashboard","Tracker"],
    ["settings","Einstellungen"]
  ];

  function renderTabs(){
    const wrap = $("tabs");
    wrap.innerHTML = "";
    const ui = getUi();
    const activeKey = (ui.lastView && TAB_DEF.some(t=>t[0]===ui.lastView)) ? ui.lastView : TAB_DEF[0][0];
    TAB_DEF.forEach(([key, label]) => {
      const b = document.createElement("button");
      b.className = "tab" + (key===activeKey ? " active" : "");
      b.textContent = label;
      b.dataset.view = key;
      b.addEventListener("click", () => showView(key));
      wrap.appendChild(b);
    });
  }

  function showView(key){
    const ui = getUi();

    // Tabs: only highlight if the key exists in TAB_DEF
    document.querySelectorAll(".tab").forEach(t => {
      const k = t.dataset.view;
      t.classList.toggle("active", k===key);
    });

    // Hide all views first
    document.querySelectorAll(".view").forEach(v => v.classList.add("hide"));

    // "Tracker" = Eingabe + Einträge in EINER Ansicht
    if(key === "dashboard"){
      $("view_dashboard").classList.remove("hide");
      // show month cards/list directly under tracker to reduce confusion
      const ts = $("view_timesheet");
      if(ts) ts.classList.remove("hide");
    } else if(key === "settings"){
      $("view_settings").classList.remove("hide");
    } else {
      // allow internal navigation (Export, Urlaub, etc.) via buttons, but not as tabs
      const v = $("view_" + key);
      if(v) v.classList.remove("hide");
      // keep a "back" memory
      if(key !== "export") ui.lastNonExportView = ui.lastNonExportView || "dashboard";
    }

    // Persist last main tab (dashboard/settings) so it doesn't jump
    if(key === "dashboard" || key === "settings"){
      saveUiPrefs({ lastView: key });
    }
    // Scroll top for clarity
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function getActivePersonId(){ return state.ui.activePersonId || state.people[0]?.id; }
  function setActivePersonId(id){ state.ui.activePersonId = id; saveState(); }

  function peopleOptions(selectEl, selectedId){
    selectEl.innerHTML = "";
    state.people.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      if(p.id === selectedId) opt.selected = true;
      selectEl.appendChild(opt);
    });
  }

  function refreshPeopleSelectors(){
    const active = getActivePersonId();
    ["selPerson","selPerson2","selPerson3","selPerson4","selPersonO"].forEach(id => {
      const el = $(id);
      if(!el) return;
      peopleOptions(el, active);
      el.onchange = () => {
        setActivePersonId(el.value);
        refreshDashboard(); refreshOverview(); refreshTimesheet(); refreshVacation(); refreshExport();
      };
    });
  }

  function entriesFor(personId){ return state.entries.filter(e => e.personId === personId); }

  function getAllowedWorkdaysSet(){
    const workdays = Number(state.cfg.workdaysPerWeek || 5);
    const allowed = new Set();
    // map: Mo=0..So=6
    if(workdays === 6){ [0,1,2,3,4,5].forEach(d => allowed.add(d)); } // Mo-Sa
    else if(workdays === 4){ [0,1,2,3].forEach(d => allowed.add(d)); } // Mo-Do
    else { [0,1,2,3,4].forEach(d => allowed.add(d)); } // Mo-Fr
    return allowed;
  }
  function isoDowMon0(dateISO){
    const d = new Date(dateISO+"T00:00:00");
    return (d.getDay()+6)%7;
  }
  function isWorkday(dateISO){
    const allowed = getAllowedWorkdaysSet();
    return allowed.has(isoDowMon0(dateISO));
  }

  function getSollPerDay(){
    const wd = Number(state.cfg.workdaysPerWeek || 5);
    const wh = Number(state.cfg.weeklyHours || 40);
    return wd > 0 ? (wh / wd) : 0; // 40/5=8
  }

  function calcWorkHours(entry){
    const startM = parseTimeToMinutes(entry.start);
    const endM = parseTimeToMinutes(entry.end);
    const breakMin = Number(entry.breakMin || 0);
    if(startM===null || endM===null) return 0;
    let dur = endM - startM;
    if(dur < 0) dur += 24*60;
    dur -= breakMin;
    dur = Math.max(0, dur);
    return dur / 60;
  }
  function hoursToHHMM(hours){
    const m = Math.round(hours * 60);
    const sign = m < 0 ? "-" : "";
    const mm = Math.abs(m);
    return sign + minutesToHHMM(mm);
  }

  function getYearsFor(personId){
    const ys = new Set([new Date().getFullYear()]);
    for(const e of entriesFor(personId)){
      if(e.type==="work" && e.date) ys.add(Number(e.date.slice(0,4)));
      if(e.type!=="work" && e.from) ys.add(Number(e.from.slice(0,4)));
    }
    // also include holiday years
    Object.keys(state.holidays || {}).forEach(y => ys.add(Number(y)));
    return Array.from(ys).filter(n => Number.isFinite(n)).sort((a,b)=>b-a);
  }

  function holidaysForYear(year){
    const arr = state.holidays?.[String(year)] || [];
    return Array.isArray(arr) ? arr : [];
  }

  // -------------------------------------------------------
  // Auto-Feiertage (DE) - Berechnung offline
  // -------------------------------------------------------
  function easterSundayISO(year){
    // Meeus/Jones/Butcher algorithm (Gregorian calendar)
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19*a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2*e + 2*i - h - k) % 7;
    const m = Math.floor((a + 11*h + 22*l) / 451);
    const month = Math.floor((h + l - 7*m + 114) / 31); // 3=March, 4=April
    const day = ((h + l - 7*m + 114) % 31) + 1;
    const mm = String(month).padStart(2,"0");
    const dd = String(day).padStart(2,"0");
    return `${year}-${mm}-${dd}`;
  }

  function addDaysISO(dateISO, days){
    const d = new Date(dateISO+"T00:00:00");
    d.setDate(d.getDate()+days);
    return d.toISOString().slice(0,10);
  }

  function repentanceDayISO(year){
    // Buß- und Bettag: Wednesday before Nov 23 (between 16-22 Nov)
    const d = new Date(`${year}-11-23T00:00:00`);
    // 0 Sun..6 Sat, Wednesday=3
    let offset = (d.getDay() - 3 + 7) % 7;
    if(offset === 0) offset = 7; // take the previous Wednesday, not the 23rd itself
    d.setDate(d.getDate() - offset);
    return d.toISOString().slice(0,10);
  }

  function germanPublicHolidays(year, stateCode, opts){
    // opts: {assumptionBY:boolean, peaceAugsburg:boolean, corpusPartial:boolean}
    const o = Object.assign({assumptionBY:true, peaceAugsburg:false, corpusPartial:false}, opts||{});
    const E = easterSundayISO(year);

    const add = (arr, dateISO, name) => arr.push({ dateISO, name, auto:true, src:`DE_${stateCode}` });

    const arr = [];
    // National (in allen 16 Laendern)
    add(arr, `${year}-01-01`, "Neujahr");
    add(arr, addDaysISO(E, -2), "Karfreitag");
    add(arr, addDaysISO(E, 1), "Ostermontag");
    add(arr, `${year}-05-01`, "Tag der Arbeit");
    add(arr, addDaysISO(E, 39), "Christi Himmelfahrt");
    add(arr, addDaysISO(E, 50), "Pfingstmontag");
    add(arr, `${year}-10-03`, "Tag der Deutschen Einheit");
    add(arr, `${year}-12-25`, "1. Weihnachtstag");
    add(arr, `${year}-12-26`, "2. Weihnachtstag");

    // Laenderspezifisch
    const has = (codes) => codes.includes(stateCode);

    if(has(["BW","BY","ST"])) add(arr, `${year}-01-06`, "Heilige Drei Koenige (Epiphanias)");
    if(has(["BE","MV"])) add(arr, `${year}-03-08`, "Internationaler Frauentag");
    if(has(["BW","BY","HE","NW","RP","SL"])) add(arr, addDaysISO(E, 60), "Fronleichnam");
    if(has(["SN","TH"]) && o.corpusPartial) add(arr, addDaysISO(E, 60), "Fronleichnam (regional)");

    if(stateCode==="BY" && o.assumptionBY) add(arr, `${year}-08-15`, "Mariae Himmelfahrt (regional in BY)");
    if(stateCode==="SL") add(arr, `${year}-08-15`, "Mariae Himmelfahrt");
    if(stateCode==="BY" && o.peaceAugsburg) add(arr, `${year}-08-08`, "Augsburger Friedensfest (nur Augsburg)");

    if(stateCode==="TH") add(arr, `${year}-09-20`, "Weltkindertag");

    // Reformationstag: ueberall ausser BW, BY, BE, HE, NW, RP, SL
    if(!has(["BW","BY","BE","HE","NW","RP","SL"])) add(arr, `${year}-10-31`, "Reformationstag");

    if(has(["BW","BY","NW","RP","SL"])) add(arr, `${year}-11-01`, "Allerheiligen");

    if(stateCode==="SN") add(arr, repentanceDayISO(year), "Buß- und Bettag");

    // Brandenburg: Easter Sunday & Whit Sunday are also public holidays, but Sunday anyway -> optional not needed
    // We keep them out intentionally (no effect on Soll with Mo-Fr / Mo-Sa models).
    return arr;
  }

  function autoHolidayYearsList(){
    const y = new Date().getFullYear();
    const years = [];
    for(let i=y-2;i<=y+5;i++) years.push(i);
    return years;
  }
  function holidayMapForRange(fromISO, toISO){
    const map = new Map(); // dateISO -> name
    const yFrom = Number(fromISO.slice(0,4));
    const yTo = Number(toISO.slice(0,4));
    for(let y=yFrom; y<=yTo; y++){
      for(const h of holidaysForYear(y)){
        if(h?.dateISO && dateToTs(h.dateISO) >= dateToTs(fromISO) && dateToTs(h.dateISO) <= dateToTs(toISO)){
          map.set(h.dateISO, h.name || "Feiertag");
        }
      }
    }
    return map;
  }
  function countWorkdayHolidaysInRange(fromISO, toISO){
    const map = holidayMapForRange(fromISO, toISO);
    let c = 0;
    for(const d of map.keys()){
      if(isWorkday(d)) c++;
    }
    return c;
  }
  function countWorkdayAbsencesInRange(personId, fromISO, toISO){
    // counts only workdays for absences (urlaub/krank/sonst)
    const arr = entriesFor(personId);
    let vacation = 0, sick = 0, other = 0;

    for(const e of arr){
      if(e.type === "work") continue;
      const aFrom = e.from, aTo = e.to;
      if(!aFrom || !aTo) continue;
      // iterate overlap days but count only workdays
      const start = Math.max(dateToTs(fromISO), dateToTs(aFrom));
      const end = Math.min(dateToTs(toISO), dateToTs(aTo));
      if(end < start) continue;

      let d = new Date(start);
      const endD = new Date(end);
      while(d.getTime() <= endD.getTime()){
        const iso = d.toISOString().slice(0,10);
        if(isWorkday(iso)){
          if(e.type==="urlaub") vacation++;
          else if(e.type==="krank") sick++;
          else other++;
        }
        d.setDate(d.getDate()+1);
      }
    }
    return { vacation, sick, other };
  }

  function sumWorkHours(personId, fromISO, toISO){
    const arr = entriesFor(personId);
    let workH = 0;
    for(const e of arr){
      if(e.type !== "work") continue;
      if(!e.date) continue;
      const t = dateToTs(e.date);
      if(t >= dateToTs(fromISO) && t <= dateToTs(toISO)){
        workH += calcWorkHours(e);
      }
    }
    return workH;
  }

  function plannedWorkdaysBetween(fromISO, toISO){
    let count = 0;
    eachDay(fromISO, toISO, (iso)=>{
      if(isWorkday(iso)) count++;
    });
    return count;
  }


  function isFullMonthRange(fromISO, toISO){
    return fromISO === startOfMonthISO(fromISO) && toISO === endOfMonthISO(fromISO);
  }
  function isFullYearRange(fromISO, toISO){
    const y = Number(fromISO.slice(0,4));
    return fromISO === startOfYearISO(y) && toISO === endOfYearISO(y);
  }
  function monthKeyFromISO(dateISO){ return dateISO.slice(0,7); } // YYYY-MM
  function getAggregate(personId, year){
    const byPerson = state.aggregates?.[personId];
    if(!byPerson) return null;
    return byPerson[String(year)] || null;
  }
  function getAggregateMonth(personId, year, month2){
    const ag = getAggregate(personId, year);
    if(!ag || !ag.months) return null;
    return ag.months[month2] || null;
  }

  function getCarry(personId, year){
    const byPerson = state.carry?.[personId];
    if(!byPerson) return { hours:0, vacation:0 };
    const c = byPerson[String(year)] || {};
    return {
      hours: Number(c.hours || 0),
      vacation: Number(c.vacation || 0)
    };
  }
  function setCarry(personId, year, hours, vacation){
    if(!state.carry) state.carry = {};
    if(!state.carry[personId]) state.carry[personId] = {};
    state.carry[personId][String(year)] = { hours:Number(hours||0), vacation:Number(vacation||0) };
  }

  function computePeriod(personId, fromISO, toISO){
    // If we have imported aggregates and the range matches exactly a month or year, use them for perfect month/year KPIs.
    const y = Number(fromISO.slice(0,4));
    const month2 = fromISO.slice(5,7);
    const agYear = getAggregate(personId, y);

    if(isFullYearRange(fromISO, toISO) && agYear && agYear.totals){
      const t = agYear.totals;
      const sollPerDay = getSollPerDay();
      const plannedWorkdays = plannedWorkdaysBetween(fromISO, toISO);
      const abs = { vacation: Number(t.urlaubDays||0), sick: Number(t.krankDays||0), other: Number(t.otherDays||0) };
      const holidayWorkdays = Number(t.feiertagDays||0);
      const reducedDays = abs.vacation + abs.sick + abs.other + holidayWorkdays;
      const effectiveWorkdays = Math.max(0, plannedWorkdays - reducedDays);
      const sollHours = Number(t.sollHours||0);
      const workH = Number(t.istHours||0);
      const diff = workH - sollHours;
      const carry = getCarry(personId, y);
      const diffWithCarry = diff + (carry.hours||0);
      return { fromISO, toISO, plannedWorkdays, holidayWorkdays, abs, reducedDays, effectiveWorkdays, sollPerDay, sollHours, workH, diff, carryHours:(carry.hours||0), diffWithCarry, source:"csv" };
    }

    if(isFullMonthRange(fromISO, toISO) && agYear){
      const m = getAggregateMonth(personId, y, month2);
      if(m){
        const sollPerDay = getSollPerDay();
        const plannedWorkdays = plannedWorkdaysBetween(fromISO, toISO);
        const abs = { vacation: Number(m.urlaubDays||0), sick: Number(m.krankDays||0), other: Number(m.otherDays||0) };
        const holidayWorkdays = Number(m.feiertagDays||0);
        const reducedDays = abs.vacation + abs.sick + abs.other + holidayWorkdays;
        const effectiveWorkdays = Math.max(0, plannedWorkdays - reducedDays);
        const sollHours = Number(m.sollHours||0);
        const workH = Number(m.istHours||0);
        const diff = workH - sollHours;
        const carry = getCarry(personId, y);
      const diffWithCarry = diff + (carry.hours||0);
      return { fromISO, toISO, plannedWorkdays, holidayWorkdays, abs, reducedDays, effectiveWorkdays, sollPerDay, sollHours, workH, diff, carryHours:(carry.hours||0), diffWithCarry, source:"csv" };
      }
    }

    const sollPerDay = getSollPerDay();
    const holidayMap = holidayMapForRange(fromISO, toISO);
    const absMap = getAbsenceTypeByDate(personId, fromISO, toISO);
    const workMap = getWorkEntriesByDate(personId, fromISO, toISO);

    let plannedWorkdays = 0;
    let holidayWorkdays = 0;
    const abs = { vacation:0, sick:0, other:0 };

    let sollHours = 0;
    let workH = 0; // Ist (inkl. Auto-Gutschrift)

    eachDay(fromISO, toISO, (dISO)=>{
      const isWd = isWorkday(dISO);
      if(isWd) plannedWorkdays++;

      const holidayName = holidayMap.get(dISO);
      const absInfo = absMap.get(dISO);

      // base work hours from manual entries
      const works = workMap.get(dISO) || [];
      const manualWork = works.reduce((sum, w)=> sum + calcWorkHours(w), 0);

      // Soll / Ist pro Tag:
      // - Arbeitstag: Soll = sollPerDay, ausser Typ "sonst" -> Soll = 0
      // - Wochenende: Soll = 0
      let daySoll = 0;
      let dayIst = manualWork;

      if(isWd){
        if(holidayName){
          holidayWorkdays++;
          daySoll = sollPerDay;
          dayIst += sollPerDay; // auto 8h
        }else if(absInfo){
          if(absInfo.type==="urlaub"){ abs.vacation++; daySoll = sollPerDay; dayIst += sollPerDay; }
          else if(absInfo.type==="krank"){ abs.sick++; daySoll = sollPerDay; dayIst += sollPerDay; }
          else { abs.other++; daySoll = 0; } // sonst: Soll=0, keine Auto-Stunden
        }else{
          daySoll = sollPerDay;
        }
      }

      sollHours += daySoll;
      workH += dayIst;
    });

    const diff = workH - sollHours;
    const reducedDays = abs.vacation + abs.sick + abs.other + holidayWorkdays;
    const effectiveWorkdays = plannedWorkdays; // da Urlaub/Krank/Feiertag als Auto-Ist zaehlen

    const yearCarry = (isFullYearRange(fromISO, toISO) ? getCarry(personId, y) : {hours:0,vacation:0});
    const carryHours = Number(yearCarry.hours||0);
    const diffWithCarry = diff + carryHours;

    return {
      fromISO, toISO,
      plannedWorkdays,
      holidayWorkdays,
      abs,
      reducedDays,
      effectiveWorkdays,
      sollPerDay,
      sollHours,
      workH,
      diff,
      carryHours,
      diffWithCarry
    };
  }

  // UI helpers
  function escapeHtml(str){
    return String(str ?? "").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }
  function escapeAttr(str){ return escapeHtml(str).replace(/"/g,"&quot;"); }

  function badge(type){
    if(type==="work") return `<span class="badge badgeWork">Arbeit</span>`;
    if(type==="urlaub") return `<span class="badge badgeUrlaub">Urlaub</span>`;
    if(type==="krank") return `<span class="badge badgeKrank">Krank</span>`;
    if(type==="holiday") return `<span class="badge badgeHoliday">Feiertag</span>`;
    return `<span class="badge badgeSonst">Sonst</span>`;
  }

  // -------------------------------------------------------
  // Modal helpers + Day Editor
  // -------------------------------------------------------
  function showModal(id){
    $("modalBackdrop").classList.remove("hide");
    $(id).classList.remove("hide");
  }
  function hideModal(id){
    $(id).classList.add("hide");
    $("modalBackdrop").classList.add("hide");
  }
  function closeAllModals(){
    $("nameSetupModal").classList.add("hide");
    $("dayEditModal").classList.add("hide");
    $("modalBackdrop").classList.add("hide");
  }

  function findAbsenceEntryForDay(personId, dateISO){
    for(const e of entriesFor(personId)){
      if(e.type==="work") continue;
      if(!e.from || !e.to) continue;
      if(dateToTs(dateISO) >= dateToTs(e.from) && dateToTs(dateISO) <= dateToTs(e.to)){
        return e;
      }
    }
    return null;
  }

  function splitAbsenceEntry(entry, dateISO){
    // Split a multi-day absence into left / right parts excluding dateISO.
    const from = entry.from, to = entry.to;
    if(from === to && from === dateISO) return; // nothing
    const leftTo = addDaysISO(dateISO, -1);
    const rightFrom = addDaysISO(dateISO, 1);

    const newEntries = [];
    if(dateToTs(from) < dateToTs(dateISO)){
      newEntries.push({
        id: crypto.randomUUID(),
        personId: entry.personId,
        type: entry.type,
        from,
        to: leftTo,
        note: entry.note || "",
        createdAt: new Date().toISOString()
      });
    }
    if(dateToTs(dateISO) < dateToTs(to)){
      newEntries.push({
        id: crypto.randomUUID(),
        personId: entry.personId,
        type: entry.type,
        from: rightFrom,
        to,
        note: entry.note || "",
        createdAt: new Date().toISOString()
      });
    }

    // remove old
    state.entries = state.entries.filter(x => x.id !== entry.id);
    // add parts
    state.entries.push(...newEntries);
  }

  function getWorkEntriesForDay(personId, dateISO){
    return entriesFor(personId).filter(e => e.type==="work" && e.date===dateISO).sort((a,b)=> (a.start||"").localeCompare(b.start||""));
  }

  function holidayNameForDay(dateISO){
    const y = dateISO.slice(0,4);
    const list = state.holidays?.[String(y)] || [];
    const h = (list||[]).find(x => x.dateISO === dateISO);
    return h ? (h.name || "Feiertag") : "";
  }

  function setHolidayForDay(dateISO, name){
    const y = dateISO.slice(0,4);
    if(!state.holidays) state.holidays = {};
    if(!Array.isArray(state.holidays[String(y)])) state.holidays[String(y)] = [];
    // replace by date
    state.holidays[String(y)] = state.holidays[String(y)].filter(h => h.dateISO !== dateISO);
    state.holidays[String(y)].push({ dateISO, name: (name||"Feiertag").trim(), auto:false });
    state.holidays[String(y)].sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
  }

  function removeHolidayForDay(dateISO){
    const y = dateISO.slice(0,4);
    if(!state.holidays?.[String(y)]) return;
    state.holidays[String(y)] = state.holidays[String(y)].filter(h => h.dateISO !== dateISO);
  }

  let dayEditCtx = { personId:null, dateISO:null, workIndex:0 };

  function syncDayEditorWorkPick(){
    const works = getWorkEntriesForDay(dayEditCtx.personId, dayEditCtx.dateISO);
    const sel = $("dayEditWorkPick");
    sel.innerHTML = "";
    works.forEach((w, idx)=>{
      const o = document.createElement("option");
      o.value = String(idx);
      o.textContent = `${w.start}-${w.end} (${Number(w.breakMin||0)}m)`;
      sel.appendChild(o);
    });
    if(works.length === 0){
      const o = document.createElement("option");
      o.value = "0";
      o.textContent = "Kein Eintrag (neu anlegen)";
      sel.appendChild(o);
      dayEditCtx.workIndex = 0;
    }else{
      dayEditCtx.workIndex = Math.min(dayEditCtx.workIndex, works.length-1);
      sel.value = String(dayEditCtx.workIndex);
    }
  }

  function fillWorkFieldsFromSelected(){
    const works = getWorkEntriesForDay(dayEditCtx.personId, dayEditCtx.dateISO);
    const idx = Number($("dayEditWorkPick").value || 0);
    dayEditCtx.workIndex = idx;

    const w = works[idx];
    if(w){
      $("dayEditStart").value = w.start || "07:00";
      $("dayEditEnd").value = w.end || "16:00";
      $("dayEditBreak").value = String(Number(w.breakMin||0));
      $("dayEditNote").value = w.note || "";
    }else{
      $("dayEditStart").value = "07:00";
      $("dayEditEnd").value = "16:00";
      $("dayEditBreak").value = "30";
      $("dayEditNote").value = "";
    }
  }

  function setDayEditorTypeUI(type){
    const isWork = type === "work";
    $("dayEditWorkFields").classList.toggle("hide", !isWork);
    $("dayEditAbsenceFields").classList.toggle("hide", isWork);
    $("dayEditWorkPickWrap").style.display = isWork ? "" : "none";
    $("dayEditHolidayNameWrap").style.display = (type==="holiday") ? "" : "none";
  }

  function openDayEditor(dateISO, personId){
    dayEditCtx = { personId, dateISO, workIndex:0 };

    const person = state.people.find(p => p.id===personId);
    $("dayEditSubtitle").textContent = `${dateISO} - ${person?.name || ""}`;

    // detect current type
    const holidayMap = holidayMapForRange(dateISO, dateISO);
    const holidayName = holidayMap.get(dateISO) || "";
    const abs = findAbsenceEntryForDay(personId, dateISO);
    const works = getWorkEntriesForDay(personId, dateISO);

    let type = "none";
    if(holidayName) type = "holiday";
    else if(abs) type = abs.type;
    else if(works.length) type = "work";

    $("dayEditType").value = type;
    $("dayEditHolidayName").value = holidayName || "Feiertag";
    syncDayEditorWorkPick();
    fillWorkFieldsFromSelected();
    setDayEditorTypeUI(type);

    $("dayEditWorkPick").onchange = () => fillWorkFieldsFromSelected();
    $("dayEditType").onchange = () => {
      setDayEditorTypeUI($("dayEditType").value);
      if($("dayEditType").value === "holiday"){
        $("dayEditHolidayName").value = holidayNameForDay(dateISO) || "Feiertag";
      }
    };

    showModal("dayEditModal");
  }

  function clearDay(personId, dateISO){
    // remove work entries of that date
    state.entries = state.entries.filter(e => !(e.personId===personId && e.type==="work" && e.date===dateISO));

    // remove/adjust absence entry that covers this date
    const abs = findAbsenceEntryForDay(personId, dateISO);
    if(abs){
      if(abs.from !== abs.to){
        splitAbsenceEntry(abs, dateISO);
      }else{
        state.entries = state.entries.filter(e => e.id !== abs.id);
      }
    }
    // remove manual holiday on that date (keep auto? user expects edit -> remove)
    removeHolidayForDay(dateISO);
  }

  function saveWorkFromEditor(){
    const personId = dayEditCtx.personId;
    const dateISO = dayEditCtx.dateISO;
    // if there is an absence/holiday and user saves work, we keep them (can create overtime)
    const works = getWorkEntriesForDay(personId, dateISO);
    const idx = Number($("dayEditWorkPick").value || 0);
    const start = $("dayEditStart").value || "07:00";
    const end = $("dayEditEnd").value || "16:00";
    const breakMin = Number($("dayEditBreak").value || 0);
    const note = ($("dayEditNote").value || "").trim();

    if(works[idx]){
      works[idx].start = start;
      works[idx].end = end;
      works[idx].breakMin = breakMin;
      works[idx].note = note;
    }else{
      state.entries.push({
        id: crypto.randomUUID(),
        personId,
        type:"work",
        date: dateISO,
        start, end, breakMin, note,
        createdAt: new Date().toISOString()
      });
    }

    // If there is a multi-day absence covering this day, keep it as-is (user may want overtime).
    saveState();
    refreshAll();
  }

  function addNewWorkEntry(){
    const personId = dayEditCtx.personId;
    const dateISO = dayEditCtx.dateISO;
    state.entries.push({
      id: crypto.randomUUID(),
      personId,
      type:"work",
      date: dateISO,
      start:"07:00", end:"16:00",
      breakMin:30,
      note:"",
      createdAt: new Date().toISOString()
    });
    saveState();
    refreshAll();
    dayEditCtx.workIndex = getWorkEntriesForDay(personId, dateISO).length - 1;
    syncDayEditorWorkPick();
    $("dayEditWorkPick").value = String(dayEditCtx.workIndex);
    fillWorkFieldsFromSelected();
  }

  function deleteSelectedWorkEntry(){
    const personId = dayEditCtx.personId;
    const dateISO = dayEditCtx.dateISO;
    const works = getWorkEntriesForDay(personId, dateISO);
    const idx = Number($("dayEditWorkPick").value || 0);
    const w = works[idx];
    if(!w){ alert("Kein Arbeits-Eintrag vorhanden."); return; }
    if(!confirm("Arbeits-Eintrag loeschen?")) return;
    state.entries = state.entries.filter(e => e.id !== w.id);
    saveState();
    refreshAll();
    dayEditCtx.workIndex = 0;
    syncDayEditorWorkPick();
    fillWorkFieldsFromSelected();
  }

  function saveAbsenceOrHolidayFromEditor(){
    const personId = dayEditCtx.personId;
    const dateISO = dayEditCtx.dateISO;
    const type = $("dayEditType").value;

    // first: clear existing for this day (work stays unless user chose none)
    // remove absence on this day
    const abs = findAbsenceEntryForDay(personId, dateISO);
    if(abs){
      if(abs.from !== abs.to) splitAbsenceEntry(abs, dateISO);
      else state.entries = state.entries.filter(e => e.id !== abs.id);
    }

    if(type === "holiday"){
      setHolidayForDay(dateISO, $("dayEditHolidayName").value || "Feiertag");
    } else {
      // remove holiday if switching away
      removeHolidayForDay(dateISO);

      if(type === "urlaub" || type === "krank" || type === "sonst"){
        state.entries.push({
          id: crypto.randomUUID(),
          personId,
          type,
          from: dateISO,
          to: dateISO,
          note: "",
          createdAt: new Date().toISOString()
        });
      }
      if(type === "none"){
        // do nothing
      }
    }

    saveState();
    refreshAll();
  }

  
  function renderQuickTotals(personId){
    const box = $("quickTotals");
    if(!box) return;

    const today = todayISO();
    const wFrom = startOfWeekISO(today), wTo = endOfWeekISO(today);
    const mFrom = startOfMonthISO(today), mTo = endOfMonthISO(today);
    const yFrom = startOfYearISO(Number(today.slice(0,4))), yTo = endOfYearISO(Number(today.slice(0,4)));

    const pw = computePeriod(personId, wFrom, wTo);
    const pm = computePeriod(personId, mFrom, mTo);
    const py = computePeriod(personId, yFrom, yTo);

    const year = Number(today.slice(0,4));
    const baseVac = Number(state.cfg?.vacationDaysPerYear || 30) + (getCarry(personId, year).vacation || 0);
    const usedVac = Number(py.abs?.vacation || 0);
    const restVac = Math.max(0, baseVac - usedVac);

    function card(title, val, cls){
      return `<div class="totCard ${cls}"><div class="lbl">${escapeHtml(title)}</div><div class="val mono">${escapeHtml(val)}</div></div>`;
    }
    function diffCard(title, diff){
      const cls = diff>=0 ? "ok" : "bad";
      const val = (diff>=0?"+":"") + hoursToHHMM(diff);
      return card(title, val, cls);
    }

    box.innerHTML = [
      card("Woche Ist", hoursToHHMM(pw.workH), "neutral"),
      diffCard("Woche +/-", pw.diff),
      card("Monat Ist", hoursToHHMM(pm.workH), "neutral"),
      diffCard("Monat +/-", pm.diff),
      card("Jahr Ist", hoursToHHMM(py.workH), "neutral"),
      diffCard("Jahr +/-", py.diff),
      card("Urlaub Rest", `${Number(restVac).toFixed(1)} d`, "small neutral"),
      card("Urlaub Genommen", `${Number(py.abs.vacation||0)} d`, "small neutral"),
      card("Krank", `${Number(py.abs.sick||0)} d`, "small neutral"),
      card("Feiertage", `${Number(py.holidayWorkdays||0)} d`, "small neutral")
    ].join("");
  }

function refreshDashboard(){
    const personId = $("selPerson").value || getActivePersonId();
    setActivePersonId(personId);
    renderQuickTotals(personId);

    const scope = $("selScope").value;
    const nowISO = todayISO();
    let fromISO = nowISO, toISO = nowISO;

    if(scope === "day"){
      fromISO = nowISO; toISO = nowISO;
    } else if(scope === "week"){
      fromISO = startOfWeekISO(nowISO); toISO = endOfWeekISO(nowISO);
    } else if(scope === "month"){
      fromISO = startOfMonthISO(nowISO); toISO = endOfMonthISO(nowISO);
    } else if(scope === "year"){
      const y = new Date().getFullYear();
      fromISO = startOfYearISO(y); toISO = endOfYearISO(y);
    } else {
      $("customRange").style.display = "";
      $("customRange2").style.display = "";
      fromISO = $("fromDate").value || startOfWeekISO(nowISO);
      toISO = $("toDate").value || endOfWeekISO(nowISO);
    }
    if(scope !== "custom"){
      $("customRange").style.display = "none";
      $("customRange2").style.display = "none";
      $("fromDate").value = fromISO;
      $("toDate").value = toISO;
    }

    const period = computePeriod(personId, fromISO, toISO);
    const agYear = getAggregate(personId, Number(fromISO.slice(0,4)));
    const diffCls = period.diff >= 0 ? "mono ok" : "mono bad";

    const kpis = [
      ["Ist (Arbeitszeit)", hoursToHHMM(period.workH), "mono"],
      ["Soll", hoursToHHMM(period.sollHours), "mono muted"],
      ["Ueber/Minus", (period.diff>=0?"+":"") + hoursToHHMM(period.diff), diffCls],
      ["Arbeitstage (geplant)", String(period.plannedWorkdays), "mono"],
      ["Feiertage (Workdays)", String(period.holidayWorkdays), "mono"],
      ["Urlaub (Workdays)", String(period.abs.vacation), "mono"],
      ["Krank (Workdays)", String(period.abs.sick), "mono"],
      ["Zeitraum", `${fromISO} -> ${toISO}`, "tdSmall"],
      ["Quelle", period.source==="csv" ? "CSV Import (Monat/Jahr)" : "Live (Eintraege)", "tdSmall"],
      ["Quelle", period.source==="csv" ? "CSV Import (Monat/Jahr)" : "Live (Eintraege)", "tdSmall"]
    ];

    const wrap = $("kpis");
    wrap.innerHTML = "";
    kpis.forEach(([k,v,cls])=>{
      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `<div class="k">${escapeHtml(k)}</div><div class="v ${cls||""}">${escapeHtml(v)}</div>`;
      wrap.appendChild(div);
    });

    $("kpiSollDay").textContent = hoursToHHMM(period.sollPerDay);
    $("kpiSollWeek").textContent = hoursToHHMM(Number(state.cfg.weeklyHours || 0));
    $("kpiWorkdays").textContent = String(state.cfg.workdaysPerWeek || 5);

    const yearNow = new Date().getFullYear();
    $("kpiHolidayCountYear").textContent = String(holidaysForYear(yearNow).length);

    $("inDate").value = $("inDate").value || nowISO;
  }

  
  // -----------------------------
  // v12: Zeitraum-Modal & Monats-Cards
  // -----------------------------
  function showRangeModal(presetFrom, presetTo, presetType){
    const m = $("rangeModal");
    if(!m) return;
    $("rangeFrom").value = presetFrom || todayISO();
    $("rangeTo").value = presetTo || todayISO();
    $("rangeType").value = presetType || "urlaub";
    $("rangeNote").value = "";
    m.classList.remove("hide");
  }
  function hideRangeModal(){
    const m = $("rangeModal");
    if(!m) return;
    m.classList.add("hide");
  }
  function deleteAbsenceRange(from, to, type){
    const personId = getActivePersonId();
    if(!from || !to) return;
    let nf = from <= to ? from : to;
    let nt = from <= to ? to : from;
    const t = type || "urlaub";
    state.entries = state.entries.filter(e=>{
      if(e.personId !== personId) return true;
      if(e.type === "work") return true;
      if(e.type !== t) return true;
      const ef = e.from, et = e.to;
      const overlap = (ef <= nt) && (et >= nf);
      return !overlap;
    });
    saveState();
    refreshAll();
  }

  function monthNameLong(mm){
    const names = {"01":"Januar","02":"Februar","03":"März","04":"April","05":"Mai","06":"Juni","07":"Juli","08":"August","09":"September","10":"Oktober","11":"November","12":"Dezember"};
    return names[String(mm).padStart(2,"0")] || String(mm);
  }
  function enumerateDaysRange(fromISO, toISO){
    const out = [];
    let d = new Date(fromISO+"T00:00:00");
    const end = new Date(toISO+"T00:00:00");
    while(d <= end){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      out.push(`${y}-${m}-${da}`);
      d.setDate(d.getDate()+1);
    }
    return out;
  }
  function isWeekendISO(iso){
    const d = new Date(iso+"T00:00:00");
    return d.getDay()===0 || d.getDay()===6;
  }
  function hasHoliday(iso){
    return (holidayNameForDay(iso) || "").trim() !== "";
  }
  function getAbsenceTypeOnDate(personId, iso){
    // precedence: manual ranges first
    for(const e of state.entries){
      if(e.personId !== personId) continue;
      if(e.type === "work") continue;
      if(e.from <= iso && iso <= e.to) return e.type;
    }
    if(hasHoliday(iso)) return "holiday";
    return "";
  }
  function getWorkEntryOnDate(personId, iso){
    return state.entries.find(e=>e.personId===personId && e.type==="work" && e.date===iso) || null;
  }
  function kpiBox(label, value, cls){
    return `<div class="kpi ${cls}"><div class="k">${escapeHtml(label)}</div><div class="v mono">${escapeHtml(value)}</div></div>`;
  }
  function signedHHMM(h){
    const sign = h>=0 ? "+" : "-";
    return sign + hoursToHHMM(Math.abs(h));
  }

  function renderTimesheetMonthCards(personId, year, month){
    const box = $("dayCards");
    const head = $("monthHeader");
    if(!box || !head) return;

    const monthISO = `${year}-${month}-01`;
    const from = startOfMonthISO(monthISO);
    const to = endOfMonthISO(monthISO);

    const period = computePeriod(personId, from, to);

    // Vormonat
    const prevDate = new Date(Number(year), Number(month)-2, 1);
    const pISO = `${prevDate.getFullYear()}-${String(prevDate.getMonth()+1).padStart(2,"0")}-01`;
    const pFrom = startOfMonthISO(pISO);
    const pTo = endOfMonthISO(pISO);
    const pPeriod = computePeriod(personId, pFrom, pTo);

    // Saldo heute (YTD + Carry)
    const today = todayISO();
    const y = Number(today.slice(0,4));
    const yPeriod = computePeriod(personId, startOfYearISO(y), today);
    const carry = getCarry(personId, y).hours || 0;
    const saldoHeute = yPeriod.diff + carry;

    head.innerHTML = `
      <div class="monthWrap">
        <div class="entryHeader">
          <div>
            <div class="title">${monthNameLong(month)} ${year}</div>
            <div class="sub">Soll/Ist/Saldo für den Monat • Tage sind anklickbar/editierbar</div>
          </div>
        </div>
        <div class="monthKpis">
          ${kpiBox("Soll-Stunden", hoursToHHMM(period.sollH), "neutral")}
          ${kpiBox("Ist-Stunden", hoursToHHMM(period.workH), "neutral")}
          ${kpiBox("S. Vormonat", signedHHMM(pPeriod.diff), pPeriod.diff>=0 ? "pos":"neg")}
          ${kpiBox("Saldo", signedHHMM(period.diff), period.diff>=0 ? "pos":"neg")}
          ${kpiBox("Saldo heute", signedHHMM(saldoHeute), saldoHeute>=0 ? "pos":"neg")}
        </div>
      </div>
    `;

    box.innerHTML = "";
    const days = enumerateDaysRange(from, to);
    for(const iso of days){
      const shortWd = weekdayName(iso); // existing helper (So/Mo/..)
      const d = new Date(iso+"T00:00:00");
      const title = `${shortWd}, ${String(d.getDate()).padStart(2,"0")}.${String(d.getMonth()+1).padStart(2,"0")}.${d.getFullYear()}`;

      const work = getWorkEntryOnDate(personId, iso);
      const abs = getAbsenceTypeOnDate(personId, iso);

      let right = "";
      let meta = "";
      let chip = "";
      let actions = "";

      if(work){
        const h = calcWorkHours(work);
        right = `${hoursToHHMM(h)}`;
        meta = `${work.start} - ${work.end} • Pause ${Number(work.breakMin||0)} min`;
        chip = `<span class="chip">🛠️ Arbeit</span>`;
        actions = `<div class="actions">
          <button class="btnPrimary" data-act="edit" data-id="${work.id}">Edit</button>
          <button data-act="abs" data-date="${iso}">Abwesenheit</button>
        </div>`;
      }else if(abs){
        const label = abs==="urlaub" ? "Urlaub" : abs==="krank" ? "Krank" : abs==="holiday" ? "Feiertag" : "Sonst";
        right = isWeekendISO(iso) ? "" : "8:00";
        meta = isWeekendISO(iso) ? "Wochenende" : "Abwesenheit (8h automatisch)";
        const icon = abs==="urlaub" ? "🏖️" : abs==="krank" ? "🤒" : abs==="holiday" ? "🎉" : "📌";
        chip = `<span class="chip">${icon} ${label}</span>`;
        actions = `<div class="actions">
          <button data-act="abs" data-date="${iso}">Ändern</button>
        </div>`;
      }else{
        meta = isWeekendISO(iso) ? "Wochenende" : "Kein Eintrag";
        chip = isWeekendISO(iso) ? `<span class="chip">🗓️ Wochenende</span>` : `<span class="chip">➕ offen</span>`;
        actions = `<div class="actions">
          <button class="btnPrimary" data-act="work" data-date="${iso}">Arbeit</button>
          <button data-act="abs" data-date="${iso}">Abwesenheit</button>
        </div>`;
      }

      const card = document.createElement("div");
      card.className = "dayCard";
      card.innerHTML = `
        <div class="dTop">
          <div>
            <div class="dTitle">${escapeHtml(title)}</div>
            <div class="dMeta">${escapeHtml(meta)}</div>
          </div>
          <div class="dRight mono">${escapeHtml(right)}</div>
        </div>
        <div style="margin-top:8px">${chip}</div>
        ${actions}
      `;
      box.appendChild(card);
    }

    // Delegate actions
    box.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.onclick = () => {
        const act = btn.getAttribute("data-act");
        const date = btn.getAttribute("data-date");
        const id = btn.getAttribute("data-id");
        if(act==="edit" && id){
          const e = state.entries.find(x=>x.id===id);
          if(e) openEditDialog(e);
          return;
        }
        if(act==="work" && date){
      
    // v12: Zeitraum setzen Buttons
    if($("btnAbsenceRange")){
      $("btnAbsenceRange").onclick = () => {
        const d = $("inDate").value || todayISO();
        showRangeModal(d, d, "urlaub");
      };
    }
    if($("btnAbsenceRangeTS")){
      $("btnAbsenceRangeTS").onclick = () => {
        const year = Number($("selYear").value || new Date().getFullYear());
        const month = ($("selMonth2").value || String(new Date().getMonth()+1).padStart(2,"0"));
        const from = startOfMonthISO(`${year}-${month}-01`);
        const to = endOfMonthISO(`${year}-${month}-01`);
        showRangeModal(from, to, "urlaub");
      };
    }

    // v12: Modal actions
    if($("btnRangeClose")) $("btnRangeClose").onclick = hideRangeModal;
    if($("btnRangeCancel")) $("btnRangeCancel").onclick = hideRangeModal;
    if($("rangeModal")){
      $("rangeModal").addEventListener("click", (ev)=>{ if(ev.target && ev.target.id==="rangeModal") hideRangeModal(); });
    }
    if($("btnRangeApply")){
      $("btnRangeApply").onclick = () => {
        const f = $("rangeFrom").value;
        const t = $("rangeTo").value;
        const type = $("rangeType").value;
        const note = $("rangeNote").value;
        addAbsence(f, t, type, note);
        hideRangeModal();
      };
    }
    if($("btnRangeDelete")){
      $("btnRangeDelete").onclick = () => {
        const f = $("rangeFrom").value;
        const t = $("rangeTo").value;
        const type = $("rangeType").value;
        if(confirm("Bereiche dieses Typs im Zeitraum wirklich löschen?")){
          deleteAbsenceRange(f, t, type);
          hideRangeModal();
        }
      };
    }

    showView("dashboard");
          $("inDate").value = date;
          $("inStart").focus();
          return;
        }
        if(act==="abs" && date){
          showRangeModal(date, date, "urlaub");
          return;
        }
      };
    });
  }

function refreshTimesheet(){
    const personId = $("selPerson2").value || getActivePersonId();
    setActivePersonId(personId);
    renderQuickTotals(personId);

    const years = getYearsFor(personId);
    const selYear = $("selYear");
    const prevYearTS = selYear.value;
    selYear.innerHTML = "";
    years.forEach(y=>{
      const o = document.createElement("option");
      o.value = String(y);
      o.textContent = String(y);
      selYear.appendChild(o);
    });
    if(prevYearTS && years.includes(Number(prevYearTS))) selYear.value = String(prevYearTS);
    if(!selYear.value) selYear.value = String(new Date().getFullYear());

    const year = Number(selYear.value);
    const monthSel = ($("selMonth2") ? $("selMonth2").value : "");
    if($("selMonth2") && !$("selMonth2").value){ /* keep */ }
    const month = (monthSel || String(new Date().getMonth()+1).padStart(2,"0"));
    // Monats-Cards/KPIs (wie App)
    if($("monthHeader") && $("dayCards")){ try{ renderTimesheetMonthCards(personId, year, month); }catch(e){} }
    const search = ($("searchNote").value || "").toLowerCase();

    const tbody = $("tblEntries");
    tbody.innerHTML = "";

    const list = entriesFor(personId)
      .filter(e=>{
        const d0 = (e.type==="work" ? e.date : e.from) || "";
        const y1 = Number(d0.slice(0,4));
        if(y1 !== year) return false;
        if(monthSel){
          const m1 = d0.slice(5,7);
          if(m1 !== monthSel) return false;
        }
        return true;
      })
      .filter(e=>{
        if(!search) return true;
        const note = (e.note || "").toLowerCase();
        return note.includes(search);
      })
      .sort((a,b)=>{
        const da = a.type==="work" ? a.date : a.from;
        const db = b.type==="work" ? b.date : b.from;
        return (db||"").localeCompare(da||"");
      });

    for(const e of list){
      const tr = document.createElement("tr");
      let dateStr="", typeStr="", timeStr="", breakStr="", hoursStr="";
      if(e.type==="work"){
        dateStr = e.date;
        typeStr = "Arbeit";
        timeStr = `${e.start}-${e.end}`;
        breakStr = `${Number(e.breakMin||0)} min`;
        hoursStr = hoursToHHMM(calcWorkHours(e));
      }else{
        dateStr = (e.from===e.to) ? e.from : `${e.from}-${e.to}`;
        typeStr = e.type==="urlaub" ? "Urlaub" : e.type==="krank" ? "Krank" : "Sonst";
        timeStr = "-";
        breakStr = "-";
        hoursStr = "-";
      }

      const btns = document.createElement("div");
      btns.className = "miniBtns";

      const btnEdit = document.createElement("button");
      btnEdit.textContent = "Edit";
      btnEdit.onclick = () => openEditDialog(e);

      const btnDel = document.createElement("button");
      btnDel.className = "btnDanger";
      btnDel.textContent = "Loeschen";
      btnDel.onclick = () => {
        if(confirm("Eintrag wirklich loeschen?")){
          state.entries = state.entries.filter(x => x.id !== e.id);
          saveState();
          refreshTimesheet(); refreshDashboard(); refreshOverview(); refreshVacation(); refreshExport();
        }
      };

      btns.appendChild(btnEdit);
      btns.appendChild(btnDel);

      tr.innerHTML = `
        <td class="mono">${escapeHtml(dateStr)}</td>
        <td><b>${escapeHtml(typeStr)}</b></td>
        <td class="mono">${escapeHtml(timeStr)}</td>
        <td class="right mono">${escapeHtml(breakStr)}</td>
        <td class="right mono"><b>${escapeHtml(hoursStr)}</b></td>
        <td>${escapeHtml(e.note||"")}</td>
        <td class="right"></td>
      `;
      tr.lastElementChild.appendChild(btns);
      tbody.appendChild(tr);
    }

    // quick sums (today-based)
    const now = todayISO();
    $("sumYear").textContent = hoursToHHMM(sumWorkHours(personId, startOfYearISO(year), endOfYearISO(year)));
    $("sumMonth").textContent = hoursToHHMM(sumWorkHours(personId, startOfMonthISO(`${year}-${month}-01`), endOfMonthISO(`${year}-${month}-01`)));
    $("sumWeek").textContent = hoursToHHMM(sumWorkHours(personId, startOfWeekISO(now), endOfWeekISO(now)));

    if(!$("searchNote").dataset.tsBound){
      $("searchNote").oninput = () => refreshTimesheet();
      $("selYear").onchange = () => refreshTimesheet();
      $("selMonth2").onchange = () => refreshTimesheet();
      $("searchNote").dataset.tsBound = "1";
    }
  }

  function refreshVacation(){
    const personId = $("selPerson3").value || getActivePersonId();
    setActivePersonId(personId);
    renderQuickTotals(personId);

    const years = getYearsFor(personId);
    const selYear2 = $("selYear2");
    selYear2.innerHTML = "";
    years.forEach(y=>{
      const o = document.createElement("option");
      o.value = String(y);
      o.textContent = String(y);
      selYear2.appendChild(o);
    });
    if(!selYear2.value) selYear2.value = String(new Date().getFullYear());

    const y = Number(selYear2.value);
    const from = startOfYearISO(y);
    const to = endOfYearISO(y);

    const abs = countWorkdayAbsencesInRange(personId, from, to);
    const holidayWorkdays = countWorkdayHolidaysInRange(from, to);

    const totalVacation = Number(state.cfg.vacationDaysPerYear || 0);
    const remaining = clamp(totalVacation - abs.vacation, 0, totalVacation);

    const wrap = $("kpisVacation");
    wrap.innerHTML = "";
    const items = [
      ["Urlaub gesamt", String(totalVacation), "mono"],
      ["Urlaub genommen (Workdays)", String(abs.vacation), "mono"],
      ["Resturlaub", String(remaining), remaining>0 ? "mono ok":"mono warn"],
      ["Krank (Workdays)", String(abs.sick), "mono"],
      ["Feiertage (Workdays)", String(holidayWorkdays), "mono"],
    ];
    items.forEach(([k,v,cls])=>{
      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `<div class="k">${escapeHtml(k)}</div><div class="v ${cls||""}">${escapeHtml(v)}</div>`;
      wrap.appendChild(div);
    });

    $("selYear2").onchange = () => refreshVacation();
  }


  function refreshHolidaysAuto(){
    // years dropdowns
    const years = autoHolidayYearsList();
    const fromSel = $("autoHolFromYear");
    const toSel = $("autoHolToYear");
    if(fromSel && toSel){
      const prevFrom = fromSel.value;
      const prevTo = toSel.value;
      fromSel.innerHTML = ""; toSel.innerHTML = "";
      years.forEach(y=>{
        const o1 = document.createElement("option"); o1.value=String(y); o1.textContent=String(y);
        const o2 = document.createElement("option"); o2.value=String(y); o2.textContent=String(y);
        fromSel.appendChild(o1); toSel.appendChild(o2);
      });
      const yNow = String(new Date().getFullYear());
      fromSel.value = prevFrom || yNow;
      toSel.value = prevTo || yNow;
    }

    // state + options from cfg
    $("autoHolState").value = state.cfg.holidayState || "BY";
    $("optAssumptionBY").value = (state.cfg.holidayOptAssumptionBY !== false) ? "on" : "off";
    $("optPeaceAugsburg").value = state.cfg.holidayOptPeaceAugsburg ? "on" : "off";
    $("optCorpusPartial").value = state.cfg.holidayOptCorpusPartial ? "on" : "off";

    const updatePreview = () => {
      const st = $("autoHolState").value;
      const yFrom = Number($("autoHolFromYear").value);
      const yTo = Number($("autoHolToYear").value);
      const opts = {
        assumptionBY: $("optAssumptionBY").value === "on",
        peaceAugsburg: $("optPeaceAugsburg").value === "on",
        corpusPartial: $("optCorpusPartial").value === "on"
      };
      let out = [];
      for(let y=yFrom; y<=yTo; y++){
        const list = germanPublicHolidays(y, st, opts).sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
        out.push(`== ${y} (${st}) ==`);
        out.push(...list.map(h=> `${h.dateISO}  ${h.name}`));
        out.push("");
      }
      $("autoHolPreview").value = out.join("\n").trim();
    };

    ["autoHolState","autoHolFromYear","autoHolToYear","optAssumptionBY","optPeaceAugsburg","optCorpusPartial"].forEach(id=>{
      const el = $(id);
      if(el) el.onchange = () => {
        // persist cfg for next time
        state.cfg.holidayState = $("autoHolState").value;
        state.cfg.holidayOptAssumptionBY = $("optAssumptionBY").value === "on";
        state.cfg.holidayOptPeaceAugsburg = $("optPeaceAugsburg").value === "on";
        state.cfg.holidayOptCorpusPartial = $("optCorpusPartial").value === "on";
        saveState();
        updatePreview();
      };
    });

    $("btnAutoHolidaysPreview").onclick = () => updatePreview();

    $("btnAutoHolidaysApply").onclick = () => {
      const st = $("autoHolState").value;
      const yFrom = Number($("autoHolFromYear").value);
      const yTo = Number($("autoHolToYear").value);
      const opts = {
        assumptionBY: $("optAssumptionBY").value === "on",
        peaceAugsburg: $("optPeaceAugsburg").value === "on",
        corpusPartial: $("optCorpusPartial").value === "on"
      };

      if(!state.holidays) state.holidays = {};
      for(let y=yFrom; y<=yTo; y++){
        const key = String(y);
        const existing = Array.isArray(state.holidays[key]) ? state.holidays[key] : [];
        // keep manual entries; remove old auto entries for this year (any DE_* source)
        const manual = existing.filter(h => !h?.auto);
        const autoList = germanPublicHolidays(y, st, opts);
        const merged = [...manual];

        // dedupe by dateISO (manual has priority)
        const used = new Set(manual.map(h=>h.dateISO));
        for(const h of autoList){
          if(!h.dateISO) continue;
          if(used.has(h.dateISO)) continue;
          merged.push(h);
          used.add(h.dateISO);
        }

        merged.sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
        state.holidays[key] = merged;
      }
      saveState();
      updatePreview();
      refreshAll();
      alert("Auto-Feiertage eingetragen/aktualisiert.");
    };

    $("btnAutoHolidaysClear").onclick = () => {
      const yFrom = Number($("autoHolFromYear").value);
      const yTo = Number($("autoHolToYear").value);
      if(!confirm("Auto-Feiertage fuer die gewaehlten Jahr(e) entfernen? (Manuelle Feiertage bleiben)")) return;

      for(let y=yFrom; y<=yTo; y++){
        const key = String(y);
        const existing = Array.isArray(state.holidays?.[key]) ? state.holidays[key] : [];
        state.holidays[key] = existing.filter(h => !h?.auto);
      }
      saveState();
      refreshAll();
      alert("Auto-Feiertage entfernt.");
    };

    // initial preview
    updatePreview();
  }

  function refreshCarryUI(){
    const sel = $("carryPerson");
    if(!sel) return;
    sel.innerHTML = "";
    state.people.forEach(p=>{
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = p.name;
      sel.appendChild(o);
    });
    const pid = getActivePersonId();
    if(pid) sel.value = pid;

    const yNow = new Date().getFullYear();
    $("carryYear").value = $("carryYear").value || String(yNow);

    const year = Number($("carryYear").value || yNow);
    const c = getCarry(sel.value, year);
    $("carryHours").value = String(c.hours || 0);
    $("carryVacation").value = String(c.vacation || 0);
  }

  function bindCarryHandlers(){
    if(!$("btnCarrySave")) return;

    $("carryPerson").onchange = () => refreshCarryUI();
    $("carryYear").onchange = () => refreshCarryUI();

    $("btnCarrySave").onclick = () => {
      const personId = $("carryPerson").value;
      const year = Number($("carryYear").value || 0);
      const hours = Number($("carryHours").value || 0);
      const vac = Number($("carryVacation").value || 0);
      if(!personId || !year){ alert("Bitte Person/Jahr setzen."); return; }
      setCarry(personId, year, hours, vac);
      saveState();
      refreshAll();
      alert("Übertrag gespeichert.");
    };

    $("btnCarryApplyNext").onclick = () => {
      const personId = $("carryPerson").value;
      const year = Number($("carryYear").value || 0);
      if(!personId || !year){ alert("Bitte Person/Jahr setzen."); return; }

      const fromISO = startOfYearISO(year);
      const toISO = endOfYearISO(year);

      const period = computePeriod(personId, fromISO, toISO);
      const carry = getCarry(personId, year);

      // Endsaldo = Startcarry + (Ist - Soll)
      const endSaldo = (carry.hours||0) + (period.diff||0);

      // Resturlaub = StartVac + Urlaub/Jahr - genommener Urlaub (nur Arbeitstage)
      const usedVacation = period.abs?.vacation || 0;
      const rest = (carry.vacation||0) + (state.cfg.vacationDaysPerYear||30) - usedVacation;

      setCarry(personId, year+1, endSaldo, rest);
      saveState();
      refreshAll();

      alert(`Übertrag für ${year+1} gesetzt:\nStunden: ${endSaldo.toFixed(2)}\nResturlaub: ${rest}`);
    };
  }
  function refreshSettings(){
    // cfg
    $("cfgWorkdays").value = String(state.cfg.workdaysPerWeek ?? 5);
    $("cfgWeeklyHours").value = String(state.cfg.weeklyHours ?? 40);
    $("cfgVacationDays").value = String(state.cfg.vacationDaysPerYear ?? 30);

    $("cfgWorkdays").onchange = () => { state.cfg.workdaysPerWeek = Number($("cfgWorkdays").value); saveState(); refreshAll(); };
    $("cfgWeeklyHours").onchange = () => { state.cfg.weeklyHours = Number($("cfgWeeklyHours").value); saveState(); refreshAll(); };
    $("cfgVacationDays").onchange = () => { state.cfg.vacationDaysPerYear = Number($("cfgVacationDays").value); saveState(); refreshVacation(); };

    renderPeopleList();
    renderHolidaySettings();
    refreshCsvImportTargets();
    refreshCarryUI();
  }

  function renderPeopleList(){
    const wrap = $("peopleList");
    wrap.innerHTML = "";
    state.people.forEach(p=>{
      const div = document.createElement("div");
      div.className = "row";
      div.style.alignItems = "center";
      div.style.marginBottom = "8px";

      const f = document.createElement("div");
      f.className = "field";
      f.style.minWidth = "260px";
      f.innerHTML = `<label>Name</label><input value="${escapeAttr(p.name)}" />`;
      const inp = f.querySelector("input");
      inp.onchange = () => {
        p.name = inp.value.trim() || p.name;
        saveState();
        refreshPeopleSelectors();
        refreshExport();
      };

      const btn = document.createElement("button");
      btn.className = "btnDanger";
      btn.textContent = "Person loeschen";
      btn.onclick = () => {
        if(state.people.length <= 1){
          alert("Mindestens 1 Person muss bleiben.");
          return;
        }
        if(confirm(`Person "${p.name}" loeschen? Alle Eintraege dieser Person werden ebenfalls geloescht!`)){
          state.entries = state.entries.filter(e => e.personId !== p.id);
          state.people = state.people.filter(x => x.id !== p.id);
          if(state.ui.activePersonId === p.id) state.ui.activePersonId = state.people[0].id;
          saveState();
          refreshAll();
        }
      };

      div.appendChild(f);
      div.appendChild(btn);
      wrap.appendChild(div);
    });
  }

  function renderHolidaySettings(){
    const personId = getActivePersonId();
    const years = getYearsFor(personId);
    const holYear = $("holYear");
    holYear.innerHTML = "";
    years.forEach(y=>{
      const o = document.createElement("option");
      o.value = String(y);
      o.textContent = String(y);
      holYear.appendChild(o);
    });
    if(!holYear.value) holYear.value = String(new Date().getFullYear());

    $("holDate").value = $("holDate").value || `${holYear.value}-01-01`;

    holYear.onchange = () => renderHolidayTable();

    $("btnAddHoliday").onclick = () => {
      const y = $("holYear").value;
      const d = $("holDate").value;
      const name = ($("holName").value || "Feiertag").trim();
      if(!d){ alert("Bitte Datum setzen."); return; }
      if(!state.holidays) state.holidays = {};
      if(!Array.isArray(state.holidays[y])) state.holidays[y] = [];
      // de-dupe by date
      state.holidays[y] = state.holidays[y].filter(x => x.dateISO !== d);
      state.holidays[y].push({ dateISO: d, name });
      // sort
      state.holidays[y].sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
      $("holName").value = "";
      saveState();
      renderHolidayTable();
      refreshAll();
    };

    renderHolidayTable();
  }

  function renderHolidayTable(){
    const y = $("holYear").value;
    const tbody = $("holTable");
    tbody.innerHTML = "";
    const list = holidaysForYear(Number(y)).slice().sort((a,b)=> (a.dateISO||"").localeCompare(b.dateISO||""));
    for(const h of list){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(h.dateISO||"")}</td>
        <td>${escapeHtml(h.name||"")}${h.auto ? ' <span class="badge" style="margin-left:6px">AUTO</span>' : ''}</td>
        <td class="right"></td>
      `;
      const btn = document.createElement("button");
      btn.className = "btnDanger";
      btn.textContent = "Loeschen";
      btn.onclick = () => {
        if(confirm("Feiertag loeschen?")){
          state.holidays[String(y)] = (state.holidays[String(y)]||[]).filter(x => x.dateISO !== h.dateISO);
          saveState();
          renderHolidayTable();
          refreshAll();
        }
      };
      tr.lastElementChild.appendChild(btn);
      tbody.appendChild(tr);
    }
  }

  // Overview table (daily lines)
  function weekdayName(dateISO){
    const d = new Date(dateISO+"T00:00:00");
    return d.toLocaleDateString("de-DE", { weekday:"short" });
  }

  function getWorkEntriesByDate(personId, fromISO, toISO){
    const map = new Map(); // dateISO -> [entries]
    for(const e of entriesFor(personId)){
      if(e.type !== "work") continue;
      if(!e.date) continue;
      if(dateToTs(e.date) < dateToTs(fromISO) || dateToTs(e.date) > dateToTs(toISO)) continue;
      if(!map.has(e.date)) map.set(e.date, []);
      map.get(e.date).push(e);
    }
    // sort each date by start time
    for(const [k, arr] of map.entries()){
      arr.sort((a,b)=> (a.start||"").localeCompare(b.start||""));
      map.set(k, arr);
    }
    return map;
  }

  function getAbsenceTypeByDate(personId, fromISO, toISO){
    const map = new Map(); // dateISO -> {type, note}
    for(const e of entriesFor(personId)){
      if(e.type === "work") continue;
      const aFrom = e.from, aTo = e.to;
      if(!aFrom || !aTo) continue;
      const start = Math.max(dateToTs(fromISO), dateToTs(aFrom));
      const end = Math.min(dateToTs(toISO), dateToTs(aTo));
      if(end < start) continue;
      let d = new Date(start);
      const endD = new Date(end);
      while(d.getTime() <= endD.getTime()){
        const iso = d.toISOString().slice(0,10);
        map.set(iso, { type: e.type, note: e.note || "" });
        d.setDate(d.getDate()+1);
      }
    }
    return map;
  }

  function refreshOverview(){
    const personId = $("selPersonO").value || getActivePersonId();
    setActivePersonId(personId);
    renderQuickTotals(personId);

    // year/month pickers
    const years = getYearsFor(personId);
    const pickYear = $("ovPickYear");
    const prevYearOV = pickYear.value;
    pickYear.innerHTML = "";
    years.forEach(y=>{
      const o = document.createElement("option");
      o.value = String(y);
      o.textContent = String(y);
      pickYear.appendChild(o);
    });
    if(prevYearOV && years.includes(Number(prevYearOV))) pickYear.value = String(prevYearOV);
    if(!pickYear.value) pickYear.value = String(new Date().getFullYear());

    const ovPickMonth = $("ovPickMonth");
    const prevMonthOV = ovPickMonth.value;
    ovPickMonth.innerHTML = "";
    const monthNames = ["01 Jan","02 Feb","03 Maer","04 Apr","05 Mai","06 Jun","07 Jul","08 Aug","09 Sep","10 Okt","11 Nov","12 Dez"];
    monthNames.forEach((label, idx)=>{
      const m = String(idx+1).padStart(2,"0");
      const o = document.createElement("option");
      o.value = m;
      o.textContent = label;
      ovPickMonth.appendChild(o);
    });
    if(prevMonthOV) ovPickMonth.value = String(prevMonthOV).padStart(2,"0");
    const now = new Date();
    if(!ovPickMonth.value) ovPickMonth.value = String(now.getMonth()+1).padStart(2,"0");

    $("ovPickDate").value = $("ovPickDate").value || todayISO();

    const mode = $("ovMode").value;
    $("ovPickMonthWrap").style.display = (mode==="month" || mode==="year") ? "" : "none";
    $("ovPickDateWrap").style.display = (mode==="week") ? "" : "";
    // For year mode we don't need month; but keep visible? We'll hide month in year mode:
    $("ovPickMonthWrap").style.display = (mode==="month") ? "" : "none";

    let fromISO, toISO;
    const y = Number(pickYear.value);
    if(mode === "year"){
      fromISO = startOfYearISO(y);
      toISO = endOfYearISO(y);
    } else if(mode === "month"){
      const m = ovPickMonth.value;
      fromISO = `${y}-${m}-01`;
      toISO = endOfMonthISO(fromISO);
    } else {
      const ref = $("ovPickDate").value || todayISO();
      fromISO = startOfWeekISO(ref);
      toISO = endOfWeekISO(ref);
      // keep year picker aligned
      pickYear.value = String(Number(ref.slice(0,4)));
    }

    const period = computePeriod(personId, fromISO, toISO);
    const agYear = getAggregate(personId, Number(fromISO.slice(0,4)));

    const kpis = [
      ["Ist", hoursToHHMM(period.workH), "mono"],
      ["Soll", hoursToHHMM(period.sollHours), "mono muted"],
      ["Ueber/Minus", (period.diff>=0?"+":"") + hoursToHHMM(period.diff), period.diff>=0?"mono ok":"mono bad"],
      ["Arbeitstage (effektiv)", String(period.effectiveWorkdays), "mono"],
      ["Urlaub (Workdays)", String(period.abs.vacation), "mono"],
      ["Krank (Workdays)", String(period.abs.sick), "mono"],
      ["Feiertage (Workdays)", String(period.holidayWorkdays), "mono"],
      ["Zeitraum", `${fromISO} -> ${toISO}`, "tdSmall"],
      ["Quelle", period.source==="csv" ? "CSV Import (Monat/Jahr)" : "Live (Eintraege)", "tdSmall"]
    ];
    const wrap = $("ovKpis");
    wrap.innerHTML = "";
    kpis.forEach(([k,v,cls])=>{
      const div = document.createElement("div");
      div.className = "kpi";
      div.innerHTML = `<div class="k">${escapeHtml(k)}</div><div class="v ${cls||""}">${escapeHtml(v)}</div>`;
      wrap.appendChild(div);
    });

    // daily lines
    const holidayMap = holidayMapForRange(fromISO, toISO);
    const absMap = getAbsenceTypeByDate(personId, fromISO, toISO);
    const workMap = getWorkEntriesByDate(personId, fromISO, toISO);

    const onlyWorkdays = $("ovOnlyWorkdays").value === "yes";

    const tbody = $("ovTable");
    tbody.innerHTML = "";

    const sollPerDay = getSollPerDay();

    eachDay(fromISO, toISO, (dISO)=>{
      const isWd = isWorkday(dISO);
      if(onlyWorkdays && !isWd) return;

      const holidayName = holidayMap.get(dISO);
      const abs = absMap.get(dISO);

      // Determine day type (priority: holiday -> absence -> work -> empty)
      let dayType = null;
      let note = "";
      if(holidayName){
        dayType = "holiday";
        note = holidayName;
      } else if(abs){
        dayType = abs.type;
        note = abs.note || "";
      }

      // Work entries (can exist even on holiday/absence)
      const works = workMap.get(dISO) || [];
      const workHours = works.reduce((sum, w)=> sum + calcWorkHours(w), 0);
      const workTimeStr = works.length ? works.map(w => `${w.start}-${w.end}`).join(", ") : "-";
      const breakStr = works.length ? works.map(w => `${Number(w.breakMin||0)}m`).join(", ") : "-";
      const workNote = works.length ? works.map(w => w.note||"").filter(Boolean).join(" | ") : "";
      if(workNote) note = note ? (note + " | " + workNote) : workNote;

      // Soll/Ist for this day:
      // - workday: Soll = sollPerDay except type "sonst"
      // - holiday/urlaub/krank: Ist += sollPerDay (auto 8h)
      let sollH = 0;
      let istH = workHours;
      if(isWd){
        if(holidayName){
          sollH = sollPerDay;
          istH += sollPerDay;
        } else if(abs){
          if(abs.type==="urlaub" || abs.type==="krank"){
            sollH = sollPerDay;
            istH += sollPerDay;
          } else {
            sollH = 0;
          }
        } else {
          sollH = sollPerDay;
        }
      }
      const diff = istH - sollH;

      const typeHtml = dayType ? badge(dayType) : (works.length ? badge("work") : `<span class="badge">-</span>`);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(dISO)}</td>
        <td>${escapeHtml(weekdayName(dISO))}</td>
        <td>${typeHtml}</td>
        <td class="mono">${escapeHtml(workTimeStr)}</td>
        <td class="right mono">${escapeHtml(breakStr)}</td>
        <td class="right mono"><b>${escapeHtml(hoursToHHMM(istH))}</b></td>
        <td class="right mono">${escapeHtml(hoursToHHMM(sollH))}</td>
        <td class="right mono ${diff>=0?"ok":"bad"}">${escapeHtml((diff>=0?"+":"")+hoursToHHMM(diff))}</td>
        <td>${escapeHtml(note)}</td>
      `;
      tr.style.cursor = "pointer";
      tr.title = "Klicken zum Bearbeiten";
      tr.onclick = () => openDayEditor(dISO, personId);
      tbody.appendChild(tr);
    });

    // download + print handlers update context
    $("btnOvCsv").onclick = () => {
      const {csv, filename} = buildCsvFromDaily(personId, fromISO, toISO, "overview");
      downloadBlob(csv, filename, "text/csv;charset=utf-8");
      exportStamp();
    };
    $("btnOvXls").onclick = () => {
      const {xml, filename} = buildXlsFromDaily(personId, fromISO, toISO, "overview");
      downloadBlob(xml, filename, "application/vnd.ms-excel");
      exportStamp();
    };
    $("btnOvPrint").onclick = () => {
      openPrintWindow(personId, fromISO, toISO, "Uebersicht");
      exportStamp();
    };

    // on-change bindings
    $("ovMode").onchange = () => refreshOverview();
    $("ovPickYear").onchange = () => refreshOverview();
    $("ovPickMonth").onchange = () => refreshOverview();
    $("ovPickDate").onchange = () => refreshOverview();
    $("ovOnlyWorkdays").onchange = () => refreshOverview();
  }

  // Export view
  function refreshExport(){
    const personId = $("selPerson4").value || getActivePersonId();
    setActivePersonId(personId);
    renderQuickTotals(personId);

    const years = getYearsFor(personId);
    const selYear3 = $("selYear3");
    selYear3.innerHTML = "";
    years.forEach(y=>{
      const o = document.createElement("option");
      o.value = String(y);
      o.textContent = String(y);
      selYear3.appendChild(o);
    });
    if(!selYear3.value) selYear3.value = String(new Date().getFullYear());

    const selMonth = $("selMonth");
    selMonth.innerHTML = `<option value="">Jahr</option>`;
    const monthLabels = ["01 Jan","02 Feb","03 Maer","04 Apr","05 Mai","06 Jun","07 Jul","08 Aug","09 Sep","10 Okt","11 Nov","12 Dez"];
    monthLabels.forEach((label, idx)=>{
      const m = String(idx+1).padStart(2,"0");
      const o = document.createElement("option");
      o.value = m;
      o.textContent = label;
      selMonth.appendChild(o);
    });

    $("selYear3").onchange = () => refreshExport();
    $("selMonth").onchange = () => refreshExport();

    const y = Number(selYear3.value);
    const m = selMonth.value || "";
    const from = m ? `${y}-${m}-01` : startOfYearISO(y);
    const to = m ? endOfMonthISO(from) : endOfYearISO(y);

    $("sharePreview").value = buildShareText(personId, from, to);
    $("chipLastExport").textContent = state.ui.lastExportISO ? state.ui.lastExportISO.replace("T"," ").slice(0,16) : "-";
  }

  function buildShareText(personId, fromISO, toISO){
    const person = state.people.find(p=>p.id===personId);
    const name = person?.name || "-";
    const p = computePeriod(personId, fromISO, toISO);
    return [
      `Arbeitszeit-Uebersicht - ${name}`,
      `${fromISO} bis ${toISO}`,
      `Ist: ${hoursToHHMM(p.workH)}`,
      `Soll: ${hoursToHHMM(p.sollHours)} (Workdays: ${p.effectiveWorkdays}/${p.plannedWorkdays})`,
      `Ueber/Minus: ${(p.diff>=0?"+":"")}${hoursToHHMM(p.diff)}`,
      `Urlaub: ${p.abs.vacation} | Krank: ${p.abs.sick} | Feiertage: ${p.holidayWorkdays}`,
      `- Export aus Offline-Tool`
    ].join("\n");
  }

  // CSV/XLS helpers (Daily overview export)
  function csvCell(v){
    const s = String(v ?? "");
    if(/[;"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function safeNameForFile(name){
    return String(name||"Person").replace(/[^\wäöüÄÖÜß\- ]/g,"").trim().replace(/\s+/g,"_") || "Person";
  }

  function buildDailyRows(personId, fromISO, toISO){
    const holidayMap = holidayMapForRange(fromISO, toISO);
    const absMap = getAbsenceTypeByDate(personId, fromISO, toISO);
    const workMap = getWorkEntriesByDate(personId, fromISO, toISO);
    const sollPerDay = getSollPerDay();

    const rows = [];
    eachDay(fromISO, toISO, (dISO)=>{
      const isWd = isWorkday(dISO);
      const holidayName = holidayMap.get(dISO);
      const abs = absMap.get(dISO);
      const works = workMap.get(dISO) || [];
      const workHours = works.reduce((sum, w)=> sum + calcWorkHours(w), 0);
      const workTimeStr = works.length ? works.map(w => `${w.start}-${w.end}`).join(", ") : "";
      const breakStr = works.length ? works.map(w => `${Number(w.breakMin||0)}m`).join(", ") : "";
      const workNote = works.length ? works.map(w => w.note||"").filter(Boolean).join(" | ") : "";

      let type = "";
      let note = "";
      if(holidayName){ type = "Feiertag"; note = holidayName; }
      else if(abs){ type = abs.type==="urlaub"?"Urlaub":abs.type==="krank"?"Krank":"Sonst"; note = abs.note||""; }
      else if(works.length){ type = "Arbeit"; }
      else { type = ""; }

      if(workNote) note = note ? (note + " | " + workNote) : workNote;

      let sollH = 0;
      let istH = workHours;
      if(isWd){
        if(holidayName){
          sollH = sollPerDay;
          istH += sollPerDay;
        } else if(abs){
          if(abs.type==="urlaub" || abs.type==="krank"){
            sollH = sollPerDay;
            istH += sollPerDay;
          } else {
            sollH = 0;
          }
        } else {
          sollH = sollPerDay;
        }
      }
      const diff = istH - sollH;

      rows.push({
        date: dISO,
        weekday: weekdayName(dISO),
        isWorkday: isWd ? "Ja":"Nein",
        type,
        workTime: workTimeStr,
        breakMin: breakStr,
        ist: istH,
        soll: sollH,
        diff,
        note
      });
    });
    return rows;
  }

  function buildCsvFromDaily(personId, fromISO, toISO, label){
    const person = state.people.find(p=>p.id===personId);
    const name = person?.name || "Person";
    const safe = safeNameForFile(name);
    const rows = buildDailyRows(personId, fromISO, toISO);

    const header = ["Datum","Wochentag","Arbeitstag","Typ","Zeit","Pause","Ist_h","Soll_h","Diff_h","Notiz"];
    const lines = [header.join(";")];

    for(const r of rows){
      lines.push([
        r.date, r.weekday, r.isWorkday, r.type,
        r.workTime, r.breakMin,
        String(r.ist.toFixed(2)).replace(".",","),
        String(r.soll.toFixed(2)).replace(".",","),
        String(r.diff.toFixed(2)).replace(".",","),
        r.note
      ].map(csvCell).join(";"));
    }

    const period = computePeriod(personId, fromISO, toISO);
    const agYear = getAggregate(personId, Number(fromISO.slice(0,4)));
    lines.push("");
    lines.push(csvCell("SUMMARY")+";;;;;;;"+csvCell(""));
    lines.push(`Ist;${String(period.workH.toFixed(2)).replace(".",",")}`);
    lines.push(`Soll;${String(period.sollHours.toFixed(2)).replace(".",",")}`);
    lines.push(`Diff;${String(period.diff.toFixed(2)).replace(".",",")}`);
    lines.push(`UrlaubWorkdays;${period.abs.vacation}`);
    lines.push(`KrankWorkdays;${period.abs.sick}`);
    lines.push(`FeiertagWorkdays;${period.holidayWorkdays}`);

    const filename = `Arbeitszeit_${safe}_${fromISO}_bis_${toISO}.csv`;
    return { csv: lines.join("\n"), filename };
  }

  // Excel 2003 XML Spreadsheet (XLS)
  function xmlEscape(s){
    return String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;");
  }
  function xlsCell(value, type){
    const t = type || "String";
    return `<Cell><Data ss:Type="${t}">${xmlEscape(value)}</Data></Cell>`;
  }
  function buildXlsFromDaily(personId, fromISO, toISO, label){
    const person = state.people.find(p=>p.id===personId);
    const name = person?.name || "Person";
    const safe = safeNameForFile(name);
    const rows = buildDailyRows(personId, fromISO, toISO);
    const period = computePeriod(personId, fromISO, toISO);
    const agYear = getAggregate(personId, Number(fromISO.slice(0,4)));

    const header = ["Datum","Wochentag","Arbeitstag","Typ","Zeit","Pause","Ist (h)","Soll (h)","Diff (h)","Notiz"];

    const sheetRows = [];
    sheetRows.push(`<Row>${header.map(h=>xlsCell(h,"String")).join("")}</Row>`);
    for(const r of rows){
      sheetRows.push(`<Row>${
        [
          xlsCell(r.date,"String"),
          xlsCell(r.weekday,"String"),
          xlsCell(r.isWorkday,"String"),
          xlsCell(r.type,"String"),
          xlsCell(r.workTime,"String"),
          xlsCell(r.breakMin,"String"),
          xlsCell(Number(r.ist.toFixed(2)),"Number"),
          xlsCell(Number(r.soll.toFixed(2)),"Number"),
          xlsCell(Number(r.diff.toFixed(2)),"Number"),
          xlsCell(r.note,"String"),
        ].join("")
      }</Row>`);
    }

    const summaryRows = [];
    summaryRows.push(`<Row>${xlsCell("Arbeitszeit-Uebersicht","String")}${xlsCell(name,"String")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Zeitraum","String")}${xlsCell(fromISO+" bis "+toISO,"String")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Soll/Tag","String")}${xlsCell(Number(period.sollPerDay.toFixed(2)),"Number")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Ist (h)","String")}${xlsCell(Number(period.workH.toFixed(2)),"Number")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Soll (h)","String")}${xlsCell(Number(period.sollHours.toFixed(2)),"Number")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Diff (h)","String")}${xlsCell(Number(period.diff.toFixed(2)),"Number")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Arbeitstage geplant","String")}${xlsCell(period.plannedWorkdays,"Number")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Arbeitstage effektiv","String")}${xlsCell(period.effectiveWorkdays,"Number")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Urlaub (Workdays)","String")}${xlsCell(period.abs.vacation,"Number")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Krank (Workdays)","String")}${xlsCell(period.abs.sick,"Number")}</Row>`);
    summaryRows.push(`<Row>${xlsCell("Feiertage (Workdays)","String")}${xlsCell(period.holidayWorkdays,"Number")}</Row>`);


    // Optional: Monatswerte Sheet (wenn Jahres-Import vorhanden und Zeitraum ist ein Jahr)
    let monthSheet = "";
    if(isFullYearRange(fromISO, toISO) && agYear && agYear.months){
      const monthHeader = ["Monat","Soll (h)","Ist (h)","Diff (h)","Saldo (h)","Urlaub (Tage)","Krank (Tage)","Feiertag (Tage)"];
      const monthRows = [];
      monthRows.push(`<Row>${monthHeader.map(h=>xlsCell(h,"String")).join("")}</Row>`);
      const monthNames = {"01":"Januar","02":"Februar","03":"Maerz","04":"April","05":"Mai","06":"Juni","07":"Juli","08":"August","09":"September","10":"Oktober","11":"November","12":"Dezember"};
      Object.keys(agYear.months).sort().forEach(m2=>{
        const m = agYear.months[m2];
        monthRows.push(`<Row>${
          [
            xlsCell(monthNames[m2] || m2, "String"),
            xlsCell(Number((m.sollHours||0).toFixed(2)), "Number"),
            xlsCell(Number((m.istHours||0).toFixed(2)), "Number"),
            xlsCell(Number(((m.istHours||0)-(m.sollHours||0)).toFixed(2)), "Number"),
            xlsCell(Number((m.saldoHours||0).toFixed(2)), "Number"),
            xlsCell(Number(m.urlaubDays||0), "Number"),
            xlsCell(Number(m.krankDays||0), "Number"),
            xlsCell(Number(m.feiertagDays||0), "Number"),
          ].join("")
        }</Row>`);
      });
      monthSheet = `
 <Worksheet ss:Name="Monatswerte">
  <Table>
   ${monthRows.join("\n")}
  </Table>
 </Worksheet>`;
    }

    const xml = `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:html="http://www.w3.org/TR/REC-html40">
 <Worksheet ss:Name="Summary">
  <Table>
   ${summaryRows.join("\n")}
  </Table>
 </Worksheet>
 <Worksheet ss:Name="Tageswerte">
  <Table>
   ${sheetRows.join("\n")}
  </Table>
 </Worksheet>
${monthSheet}
</Workbook>`;

    const filename = `Arbeitszeit_${safe}_${fromISO}_bis_${toISO}.xls`;
    return { xml, filename };
  }

  function downloadBlob(content, filename, mime){
    const blob = content instanceof Blob ? content : new Blob([content], {type:mime || "application/octet-stream"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 3000);
  }

  async function shareFileOrText({title, text, files}){
    if(navigator.share){
      try{
        await navigator.share({ title, text, files });
        return true;
      }catch(e){
        return false;
      }
    }
    return false;
  }

  function exportStamp(){
    state.ui.lastExportISO = new Date().toISOString();
    saveState();
    $("chipLastExport").textContent = state.ui.lastExportISO.replace("T"," ").slice(0,16);
  }

  // Print / PDF
  function openPrintWindow(personId, fromISO, toISO, titleLabel){
    const person = state.people.find(p=>p.id===personId);
    const name = person?.name || "-";
    const period = computePeriod(personId, fromISO, toISO);
    const agYear = getAggregate(personId, Number(fromISO.slice(0,4)));
    const rows = buildDailyRows(personId, fromISO, toISO);

    const now = new Date().toLocaleString("de-DE");
    const title = `${titleLabel} - ${name}`;

    const tableRows = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.date)}</td>
        <td>${escapeHtml(r.weekday)}</td>
        <td>${escapeHtml(r.type || "")}</td>
        <td>${escapeHtml(r.workTime || "")}</td>
        <td style="text-align:right">${escapeHtml(r.breakMin || "")}</td>
        <td style="text-align:right"><b>${escapeHtml(hoursToHHMM(r.ist))}</b></td>
        <td style="text-align:right">${escapeHtml(hoursToHHMM(r.soll))}</td>
        <td style="text-align:right">${escapeHtml((r.diff>=0?"+":"")+hoursToHHMM(r.diff))}</td>
        <td>${escapeHtml(r.note || "")}</td>
      </tr>
    `).join("");

    const html = `<!doctype html>
<html><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${escapeHtml(title)}</title>
<style>
  body{font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#111; padding:20px}
  h1{font-size:18px;margin:0 0 6px}
  .muted{color:#555}
  .kpis{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 16px}
  .k{border:1px solid #ddd;border-radius:12px;padding:10px 12px;min-width:160px}
  .k b{display:block;font-size:16px;margin-top:4px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;padding:8px 6px;font-size:12px;vertical-align:top}
  th{background:#fafafa;text-align:left}
  @media print { body{padding:0} .noPrint{display:none} }
</style></head>
<body>
  <div class="noPrint" style="margin-bottom:10px;">
    <button onclick="window.print()">Drucken / PDF speichern</button>
  </div>

  <h1>${escapeHtml(title)}</h1>
  <div class="muted">${escapeHtml(fromISO)} bis ${escapeHtml(toISO)} - erstellt: ${escapeHtml(now)}</div>

  <div class="kpis">
    <div class="k"><div class="muted">Ist</div><b>${escapeHtml(hoursToHHMM(period.workH))}</b></div>
    <div class="k"><div class="muted">Soll</div><b>${escapeHtml(hoursToHHMM(period.sollHours))}</b></div>
    <div class="k"><div class="muted">Ueber/Minus</div><b>${escapeHtml((period.diff>=0?"+":"")+hoursToHHMM(period.diff))}</b></div>
    <div class="k"><div class="muted">Urlaub/Krank/Feiertag</div><b>${period.abs.vacation} / ${period.abs.sick} / ${period.holidayWorkdays}</b></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Datum</th><th>Tag</th><th>Typ</th><th>Zeit</th><th style="text-align:right">Pause</th>
        <th style="text-align:right">Ist</th><th style="text-align:right">Soll</th><th style="text-align:right">Diff</th><th>Notiz</th>
      </tr>
    </thead>
    <tbody>${tableRows || "<tr><td colspan='9' class='muted'>Keine Daten</td></tr>"}</tbody>
  </table>

  <p class="muted" style="margin-top:12px;font-size:12px">
    Soll-Logik: Arbeitstage minus Urlaub/Krank/Sonst/Feiertage (jeweils nur an Arbeitstagen).
  </p>
<\/body><\/html>`;

    const w = window.open("", "_blank");
    if(!w){ alert("Popup blockiert. Bitte Popups erlauben."); return; }
    w.document.write(html);
    w.document.close();
    w.focus();
  }

  // Export page buttons
  function exportContextFromExportTab(){
    const personId = getActivePersonId();
    const y = Number($("selYear3").value);
    const m = $("selMonth").value || "";
    const from = m ? `${y}-${m}-01` : startOfYearISO(y);
    const to = m ? endOfMonthISO(from) : endOfYearISO(y);
    return { personId, from, to };
  }

  // CRUD
  function openEditDialog(e){
    if(e.type==="work"){
      const date = prompt("Datum (YYYY-MM-DD):", e.date) || e.date;
      const start = prompt("Start (HH:MM):", e.start) || e.start;
      const end = prompt("Ende (HH:MM):", e.end) || e.end;
      const br = prompt("Pause (Min):", String(e.breakMin||0));
      const note = prompt("Notiz:", e.note||"");
      e.date = date.trim();
      e.start = start.trim();
      e.end = end.trim();
      e.breakMin = Number(br||0);
      e.note = (note||"").trim();
    }else{
      const from = prompt("Von (YYYY-MM-DD):", e.from) || e.from;
      const to = prompt("Bis (YYYY-MM-DD):", e.to) || e.to;
      const type = prompt("Typ (urlaub/krank/sonst):", e.type) || e.type;
      const note = prompt("Kommentar:", e.note||"");
      e.from = from.trim();
      e.to = to.trim();
      e.type = (type||e.type).trim();
      e.note = (note||"").trim();
    }
    saveState();
    refreshAll();
  }

  function openAddWorkWithDate(dateISO){
    // prefills quick form in dashboard
    showView("dashboard");
    $("inDate").value = dateISO;
    $("inStart").focus();
  }
  function openAddAbsWithDate(dateISO){
    showView("dashboard");
    // open absence modal prefilling from/to to date
    $("absFrom").value = dateISO;
    $("absTo").value = dateISO;
    showModal("absenceModal");
  }
  function openEditByDate(personId, dateISO){
    // if there is a work entry on that day, edit the most recent one; else open add absence
    const list = entriesFor(personId).filter(e=>{
      const d = (e.type==="work" ? e.date : e.from);
      return d === dateISO;
    }).sort((a,b)=>{
      const da = (a.type==="work"?a.date:a.from) || "";
      const db = (b.type==="work"?b.date:b.from) || "";
      return (db||"").localeCompare(da||"");
    });
    if(list.length){
      openEdit(list[0].id);
    }else{
      openAddWorkWithDate(dateISO);
    }
  }

  function addWorkEntry(){
    const personId = getActivePersonId();
    const date = $("inDate").value || todayISO();
    const start = $("inStart").value || "07:00";
    const end = $("inEnd").value || "16:00";
    const breakMin = Number($("inBreak").value || 0);
    const note = ($("inNote").value || "").trim();

    const entry = {
      id: crypto.randomUUID(),
      personId,
      type: "work",
      date,
      start,
      end,
      breakMin,
      note,
      createdAt: new Date().toISOString()
    };
    state.entries.push(entry);
    saveState();
    $("inNote").value = "";
    refreshAll();
  }

  
  function addAbsence(from, to, type, note){
    const personId = getActivePersonId();
    if(!from || !to){
      alert("Bitte Von und Bis Datum setzen.");
      return;
    }
    // normalize order
    let nf = from <= to ? from : to;
    let nt = from <= to ? to : from;

    const t = (type || "urlaub");

    // merge with existing overlapping/touching absences of same type (prevents duplicates)
    const keep = [];
    const overlaps = [];
    for(const e of state.entries){
      if(e.personId !== personId) { keep.push(e); continue; }
      if(e.type === "work") { keep.push(e); continue; }
      if(e.type !== t) { keep.push(e); continue; }
      const ef = e.from, et = e.to;
      // overlap or touch (YYYY-MM-DD compares lexicographically)
      // touch means et >= (nf - 1 day) and ef <= (nt + 1 day)
      const efOk = (ef <= nt);
      const etOk = (et >= nf);
      if(efOk && etOk){
        overlaps.push(e);
        if(ef < nf) nf = ef;
        if(et > nt) nt = et;
      }else{
        keep.push(e);
      }
    }
    state.entries = keep;

    const entry = {
      id: crypto.randomUUID(),
      personId,
      type: t,
      from: nf,
      to: nt,
      note: (note||"").trim(),
      createdAt: new Date().toISOString()
    };

    // If there was an exact same range already (rare), we already removed it above via overlap.
    state.entries.push(entry);
    saveState();
    refreshAll();
  }

  function addHolidayShortcut(){
    // opens settings holiday section quickly
    showView("settings");
    const y = String(new Date().getFullYear());
    $("holYear").value = y;
    $("holDate").value = todayISO();
    $("holName").focus();
  }

  // Buttons
  $("btnAddEntry").onclick = addWorkEntry;

  $("btnQuickToday").onclick = () => {
    
    // v14: restore UI prefs (Zeitraum/Monat merken)
    const ui = getUi();
    if(ui.dashScope && $("selScope")) $("selScope").value = ui.dashScope;
    if(ui.dashFrom && $("fromDate")) $("fromDate").value = ui.dashFrom;
    if(ui.dashTo && $("toDate")) $("toDate").value = ui.dashTo;

    if(ui.tsYear && $("selYear")) $("selYear").value = String(ui.tsYear);
    if(ui.tsMonth && $("selMonth2")) $("selMonth2").value = ui.tsMonth;

    // save prefs on change
    if($("selScope")){
      $("selScope").onchange = () => { saveUiPrefs({dashScope: $("selScope").value}); refreshDashboard(); };
    }
    if($("fromDate")){
      $("fromDate").onchange = () => { saveUiPrefs({dashFrom: $("fromDate").value}); refreshDashboard(); };
    }
    if($("toDate")){
      $("toDate").onchange = () => { saveUiPrefs({dashTo: $("toDate").value}); refreshDashboard(); };
    }
    if($("selYear")){
      $("selYear").onchange = () => { saveUiPrefs({tsYear: $("selYear").value}); refreshTimesheet(); };
    }
    if($("selMonth2")){
      $("selMonth2").onchange = () => { saveUiPrefs({tsMonth: $("selMonth2").value}); refreshTimesheet(); };
    }

    $("inDate").value = todayISO();
    showView("dashboard");
    setTimeout(()=> $("inStart").focus(), 150);
  };

  $("btnAddAbsence").onclick = () => {
    showView("urlaub");
    $("absFrom").value = $("absFrom").value || todayISO();
    $("absTo").value = $("absTo").value || $("absFrom").value;
    // little helper: if user wants holiday, they can add in settings
    setTimeout(()=>{
      if(confirm("Soll es ein FEIERTAG sein? (Feiertage werden in Einstellungen gepflegt)\nOK = Einstellungen oeffnen, Abbrechen = Urlaub/Krank/Sonst.")){
        addHolidayShortcut();
      }
    }, 100);
  };

  $("btnSaveAbs").onclick = () => {
    const from = $("absFrom").value;
    const to = $("absTo").value || from;
    addAbsence(from, to, $("absType").value, $("absNote").value);
    $("absNote").value = "";
  };

  $("btnClearAbs").onclick = () => {
    $("absFrom").value = todayISO();
    $("absTo").value = todayISO();
    $("absNote").value = "";
  };

  $("selScope").onchange = () => refreshDashboard();
  $("fromDate").onchange = () => refreshDashboard();
  $("toDate").onchange = () => refreshDashboard();

  $("btnAddPerson").onclick = () => {
    const name = ($("newPersonName").value||"").trim();
    if(!name){ alert("Bitte Name eingeben."); return; }
    state.people.push({ id: crypto.randomUUID(), name });
    $("newPersonName").value = "";
    saveState();
    refreshAll();
  };

  $("btnBackup").onclick = () => {
    downloadBlob(JSON.stringify(state, null, 2), `Arbeitszeit_Backup_${todayISO()}.json`, "application/json");
    exportStamp();
  };

  $("importFile").onchange = async (ev) => {
    const f = ev.target.files?.[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const data = JSON.parse(txt);
      if(!data || typeof data !== "object" || !data.people || !data.entries){
        alert("Ungueltiges Backup.");
        return;
      }
      // soft-accept old backups: ensure missing keys
      state = data;
      if(!state.cfg) state.cfg = defaultState().cfg;
      if(!state.holidays) state.holidays = {};
      if(!state.ui) state.ui = { activePersonId: state.people[0]?.id || null, lastExportISO:"" };
      if(!state.ui.activePersonId) state.ui.activePersonId = state.people[0]?.id || null;
      saveState();
      refreshAll(true);
      alert("Backup importiert.");
    }catch(e){
      alert("Import fehlgeschlagen: " + e.message);
    }finally{
      ev.target.value = "";
    }
  };


  // CSV Import (Jahres/Monatswerte)
  function parseGermanNumber(str){
    const s = String(str ?? "").trim();
    if(!s) return 0;
    // remove thousand separators
    const cleaned = s.replace(/\./g, "").replace(",", ".");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function monthNameToNumber(name){
    const n = String(name||"").trim().toLowerCase();
    const map = {
      "januar":"01","februar":"02","märz":"03","maerz":"03","april":"04","mai":"05","juni":"06","juli":"07",
      "august":"08","september":"09","oktober":"10","november":"11","dezember":"12"
    };
    return map[n] || null;
  }

  function parseCsvYearOverview(text){
    const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
    if(lines.length < 5) throw new Error("CSV zu kurz");

    // First line example: "Stundenuebersicht eines Jahres Markus Wolf;2025;Zaunteam"
    const first = lines[0].split(";");
    const title = first[0] || "";
    const year = Number(first[1] || 0);
    const name = title.replace(/^Stundenübersicht eines Jahres\s+/i, "").replace(/^Stundenuebersicht eines Jahres\s+/i, "").trim();

    // Find first table header
    let idx1 = lines.findIndex(l => /^Monat;Soll-Stunden;Ist-Stunden/i.test(l));
    if(idx1 < 0) throw new Error("Tabelle 'Soll/Ist' nicht gefunden");
    const header1 = lines[idx1].split(";");
    const monthRows = {};
    for(let i=idx1+1;i<lines.length;i++){
      const l = lines[i];
      if(/^Total;/i.test(l)) {
        const parts = l.split(";");
        // Total row
        var totals = {
          sollHours: parseGermanNumber(parts[1]),
          istHours: parseGermanNumber(parts[2]),
          saldoHours: parseGermanNumber(parts[6] || ""),
        };
        break;
      }
      if(!/;/.test(l)) continue;
      if(/^Monat;/i.test(l)) continue;
      const parts = l.split(";");
      const m2 = monthNameToNumber(parts[0]);
      if(!m2) continue;
      monthRows[m2] = {
        sollHours: parseGermanNumber(parts[1]),
        istHours: parseGermanNumber(parts[2]),
        saldoHours: parseGermanNumber(parts[6] || ""),
      };
    }
    if(!totals) totals = { sollHours:0, istHours:0, saldoHours:0 };

    // Find second table header (days categories)
    let idx2 = lines.findIndex(l => /^Monat;Arbeitszeit;/i.test(l));
    const dayRows = {};
    let totalsDays = { urlaubDays:0, feiertagDays:0, krankDays:0, otherDays:0 };
    if(idx2 >= 0){
      const h2 = lines[idx2].split(";");
      const colUrlaub = h2.findIndex(c => /Ferien\/Urlaub/i.test(c));
      const colFeiertag = h2.findIndex(c => /^Feiertag/i.test(c));
      const colKrank = h2.findIndex(c => /Kran/i.test(c)); // Krankenzeit...
      for(let i=idx2+1;i<lines.length;i++){
        const l = lines[i];
        if(/^Total;/i.test(l)){
          const parts = l.split(";");
          totalsDays = {
            urlaubDays: colUrlaub>=0 ? parseGermanNumber(parts[colUrlaub]) : 0,
            feiertagDays: colFeiertag>=0 ? parseGermanNumber(parts[colFeiertag]) : 0,
            krankDays: colKrank>=0 ? parseGermanNumber(parts[colKrank]) : 0,
            otherDays: 0
          };
          break;
        }
        const parts = l.split(";");
        const m2 = monthNameToNumber(parts[0]);
        if(!m2) continue;
        dayRows[m2] = {
          urlaubDays: colUrlaub>=0 ? parseGermanNumber(parts[colUrlaub]) : 0,
          feiertagDays: colFeiertag>=0 ? parseGermanNumber(parts[colFeiertag]) : 0,
          krankDays: colKrank>=0 ? parseGermanNumber(parts[colKrank]) : 0,
          otherDays: 0
        };
      }
    }

    // merge day counts into monthRows
    Object.keys(monthRows).forEach(m2=>{
      const d = dayRows[m2] || {};
      monthRows[m2].urlaubDays = d.urlaubDays || 0;
      monthRows[m2].feiertagDays = d.feiertagDays || 0;
      monthRows[m2].krankDays = d.krankDays || 0;
      monthRows[m2].otherDays = d.otherDays || 0;
    });

    totals.urlaubDays = totalsDays.urlaubDays || 0;
    totals.feiertagDays = totalsDays.feiertagDays || 0;
    totals.krankDays = totalsDays.krankDays || 0;
    totals.otherDays = totalsDays.otherDays || 0;

    return { name, year, months: monthRows, totals };
  }

  function ensurePersonByName(name){
    const n = (name||"").trim();
    if(!n) return null;
    const existing = state.people.find(p => (p.name||"").trim().toLowerCase() === n.toLowerCase());
    if(existing) return existing.id;
    const id = crypto.randomUUID();
    state.people.push({ id, name: n });
    return id;
  }

  let csvImportCache = null;
  let csvImportCacheList = [];

  function refreshCsvImportTargets(){
    const sel = $("csvImpPersonTarget");
    if(!sel) return;
    const cur = sel.value || "auto";
    sel.innerHTML = `<option value="auto">Auto: Name verwenden (Person anlegen, wenn noetig)</option>`;
    state.people.forEach(p=>{
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = p.name;
      sel.appendChild(o);
    });
    sel.value = cur;
  }

  async function handleCsvFilesSelected(files){
    csvImportCacheList = [];
    const list = Array.from(files || []).filter(Boolean);
    if(list.length===0) return;

    for(const f of list){
      const txt = await f.text();
      const parsed = parseCsvYearOverview(txt);
      parsed.__fileName = f.name || "";
      csvImportCacheList.push(parsed);
    }
    // default: use first for the editable fields
    csvImportCache = csvImportCacheList[0] || null;

    if(csvImportCache){
      $("csvImpName").value = csvImportCache.name || $("csvImpName").value || "";
      $("csvImpYear").value = csvImportCache.year || $("csvImpYear").value || (new Date().getFullYear());
    }

    const previewLines = [];
    previewLines.push(`Gefundene Dateien: ${csvImportCacheList.length}`);
    previewLines.push("");

    const monthNames = {"01":"Jan","02":"Feb","03":"Mrz","04":"Apr","05":"Mai","06":"Jun","07":"Jul","08":"Aug","09":"Sep","10":"Okt","11":"Nov","12":"Dez"};

    csvImportCacheList.forEach((p, idx)=>{
      previewLines.push(`--- #${idx+1} ${p.__fileName || ""}`.trim());
      previewLines.push(`Name: ${p.name || "-"}`);
      previewLines.push(`Jahr: ${p.year || "-"}`);
      previewLines.push(`TOTAL Soll: ${Number(p.totals.sollHours||0).toFixed(2)}  Ist: ${Number(p.totals.istHours||0).toFixed(2)}  Saldo: ${Number(p.totals.saldoHours||0).toFixed(2)}`);
      previewLines.push(`TOTAL Urlaub: ${Number(p.totals.urlaubDays||0)}  Feiertage: ${Number(p.totals.feiertagDays||0)}  Krank: ${Number(p.totals.krankDays||0)}`);
      previewLines.push("Monat  Urlaub  Feiertag  Krank");
      Object.keys(p.months||{}).sort().forEach(m2=>{
        const m = p.months[m2];
        previewLines.push(`${monthNames[m2]}  ${Number(m.urlaubDays||0)}  ${Number(m.feiertagDays||0)}  ${Number(m.krankDays||0)}`);
      });
      previewLines.push("");
    });

    $("csvImpPreview").value = previewLines.join("\n");
  }

  function applyCsvImport(){
    if(!csvImportCacheList || csvImportCacheList.length===0){
      alert("Bitte erst eine CSV Datei waehlen.");
      return;
    }

    const overrideName = ($("csvImpName").value || "").trim();
    const target = $("csvImpPersonTarget").value || "auto";

    let importedYears = [];

    for(const parsed of csvImportCacheList){
      const year = Number(parsed.year || $("csvImpYear").value || 0);
      const name = (overrideName || parsed.name || "").trim();
      if(!name){ continue; }
      if(!year || year < 2000 || year > 2100){ continue; }

      let personId = null;
      if(target === "auto"){
        personId = ensurePersonByName(name);
      }else{
        personId = target;
        const p = state.people.find(p=>p.id===personId);
        if(p) p.name = name;
      }
      if(!personId) continue;

      if(!state.aggregates) state.aggregates = {};
      if(!state.aggregates[personId]) state.aggregates[personId] = {};
      state.aggregates[personId][String(year)] = {
        source: "csv",
        importedAt: new Date().toISOString(),
        nameAtImport: name,
        months: parsed.months,
        totals: parsed.totals
      };
      // v15: auto-carry from CSV (S. Vormonat im Januar) -> setzt Anfangssaldo, falls noch nicht gepflegt
      try{
        const jan = parsed.months?.["01"];
        const carryNow = getCarry(personId, year);
        if(jan && isFinite(jan.prevSaldo) && (carryNow.hours===0)){
          setCarry(personId, year, Number(jan.prevSaldo||0), carryNow.vacation||0);
        }
      }catch(e){}

      importedYears.push(year);

      // focus to last imported
      state.ui.activePersonId = personId;
    }

    if(importedYears.length===0){
      alert("Import fehlgeschlagen: Name/Jahr nicht erkannt. (Du kannst den Namen oben eintragen.)");
      return;
    }

    saveState();
    refreshPeopleSelectors();
    refreshCsvImportTargets();
    refreshAll();
    alert("CSV uebernommen: " + importedYears.sort().join(", "));
  }

  $("btnResetAll").onclick = () => {
    if(confirm("Wirklich ALLES loeschen?")){
      localStorage.removeItem(APP_KEY);
      state = defaultState();
      saveState();
      refreshAll(true);
    }
  };

  // Export view actions
  $("btnCsv").onclick = () => {
    const { personId, from, to } = exportContextFromExportTab();
    const {csv, filename} = buildCsvFromDaily(personId, from, to, "export");
    downloadBlob(csv, filename, "text/csv;charset=utf-8");
    exportStamp();
  };

  $("btnXls").onclick = () => {
    const { personId, from, to } = exportContextFromExportTab();
    const {xml, filename} = buildXlsFromDaily(personId, from, to, "export");
    downloadBlob(xml, filename, "application/vnd.ms-excel");
    exportStamp();
  };

  $("btnReportTxt").onclick = () => {
    const { personId, from, to } = exportContextFromExportTab();
    const person = state.people.find(p=>p.id===personId);
    const safe = safeNameForFile(person?.name || "Person");
    const text = buildShareText(personId, from, to);
    downloadBlob(text, `Arbeitszeit_Bericht_${safe}_${from}_bis_${to}.txt`, "text/plain;charset=utf-8");
    exportStamp();
  };

  $("btnPrint").onclick = () => {
    const { personId, from, to } = exportContextFromExportTab();
    openPrintWindow(personId, from, to, "Export");
    exportStamp();
  };

  $("btnShare").onclick = async () => {
    const { personId, from, to } = exportContextFromExportTab();
    const text = buildShareText(personId, from, to);

    let ok = false;
    try{
      const blob = new Blob([text], {type:"text/plain"});
      const file = new File([blob], "Arbeitszeit_Bericht.txt", {type:"text/plain"});
      ok = await shareFileOrText({ title:"Arbeitszeit", text, files: [file] });
    }catch(e){ ok = false; }

    if(!ok){
      try{
        await navigator.clipboard.writeText(text);
        alert("Text kopiert. WhatsApp oeffnen und einfuegen.");
      }catch(e){
        alert("Teilen nicht unterstuetzt. Nutze WhatsApp-Text oder Download.");
      }
    }else{
      exportStamp();
    }
  };

  $("btnWhatsApp").onclick = () => {
    const { personId, from, to } = exportContextFromExportTab();
    const text = buildShareText(personId, from, to);
    window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
    exportStamp();
  };

  if($("btnBackFromExport")) $("btnBackFromExport").onclick = () => { const ui=getUi(); showView(ui.lastNonExportView || "dashboard"); };

  $("btnExportNow").onclick = () => { const ui=getUi(); ui.lastNonExportView = ui.lastView || "dashboard"; saveState(); showView("export"); };
  $("btnGoTimesheet").onclick = () => showView("timesheet");
  $("btnGoOverview").onclick = () => showView("overview");

  function refreshAll(resetUI=false){
    if(resetUI){
      renderTabs();
      refreshPeopleSelectors();
    }
    refreshDashboard();
    refreshOverview();
    refreshTimesheet();
    refreshVacation();
    refreshHolidaysAuto();
    refreshCsvImportTargets();
    refreshCarryUI();
    refreshSettings();
    refreshExport();
    $("chipLastExport").textContent = state.ui.lastExportISO ? state.ui.lastExportISO.replace("T"," ").slice(0,16) : "-";
  }

  // Init
  try{
    if(!state.ui.activePersonId) state.ui.activePersonId = state.people[0]?.id || null;
    saveState();
    renderTabs();
    refreshPeopleSelectors();
    // v14: go to last view (no tab-jumps)
    showView((getUi().lastView && TAB_DEF.some(t=>t[0]===getUi().lastView)) ? getUi().lastView : 'dashboard');

    $("inDate").value = todayISO();
    $("fromDate").value = startOfWeekISO(todayISO());
    $("toDate").value = endOfWeekISO(todayISO());
    $("absFrom").value = todayISO();
    $("absTo").value = todayISO();
    $("ovPickDate").value = todayISO();
    // Modal wiring
    $("modalBackdrop").onclick = () => closeAllModals();
    $("btnDayEditClose").onclick = () => closeAllModals();
    $("btnDayEditSaveWork").onclick = () => { saveWorkFromEditor(); };
    $("btnDayEditAddWork").onclick = () => { addNewWorkEntry(); };
    $("btnDayEditDeleteWork").onclick = () => { deleteSelectedWorkEntry(); };
    $("btnDayEditSaveAbs").onclick = () => { saveAbsenceOrHolidayFromEditor(); closeAllModals(); };
    $("btnDayEditClearDay").onclick = () => {
      if(confirm("Tag wirklich leeren? (Arbeits-Eintraege + Urlaub/Krank/Sonst + Feiertag werden entfernt)")){
        clearDay(dayEditCtx.personId, dayEditCtx.dateISO);
        saveState();
        refreshAll();
        closeAllModals();
      }
    };

    // v14: kein nerviges Name-Modal mehr (Name kann in Einstellungen geändert werden)


    // CSV Import wiring
    refreshCsvImportTargets();
    $("csvImpYear").value = String(new Date().getFullYear());
    $("csvImportFile").onchange = async (ev) => {
      const f = ev.target.files?.[0];
      if(!f) return;
      try{
        await handleCsvFilesSelected(ev.target.files);
      }catch(e){
        alert("CSV Import fehlgeschlagen: " + e.message);
      }finally{
        // keep file selected
      }
    };
    $("btnCsvImportPreview").onclick = () => {
      if(csvImportCache){
        // already in textarea
        alert("Vorschau ist unten sichtbar (auch bei mehreren Dateien).");
      }else{
        alert("Bitte erst CSV waehlen.");
      }
    };
    $("btnCsvImportApply").onclick = () => applyCsvImport();
    // Carry wiring
    bindCarryHandlers();
    refreshCarryUI();


    showView("dashboard");
    refreshAll();
  }catch(e){
    console.error(e);
    setStatus("Fehler", false);
    alert("Fehler beim Start: " + e.message);
  }
})();
</script>

  <!-- Absence Range Modal -->
  <div id="rangeModal" class="modal hide" role="dialog" aria-modal="true" aria-labelledby="rangeTitle">
    <div class="modalCard">
      <div class="modalHead">
        <div>
          <div class="modalTitle" id="rangeTitle">Abwesenheit als Zeitraum</div>
          <div class="modalSub">Von–Bis setzen (wird automatisch zusammengeführt, keine Duplikate).</div>
        </div>
        <button class="iconBtn" id="btnRangeClose" title="Schließen">✕</button>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="field" style="min-width:160px">
          <label>Von</label>
          <input type="date" id="rangeFrom">
        </div>
        <div class="field" style="min-width:160px">
          <label>Bis</label>
          <input type="date" id="rangeTo">
        </div>
        <div class="field" style="min-width:180px">
          <label>Typ</label>
          <select id="rangeType">
            <option value="urlaub">Urlaub</option>
            <option value="krank">Krank</option>
            <option value="holiday">Feiertag</option>
            <option value="other">Sonst</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field" style="flex:1">
          <label>Notiz (optional)</label>
          <input id="rangeNote" placeholder="z.B. Urlaub Italien, Krankmeldung, ...">
        </div>
      </div>

      <div class="row" style="justify-content:space-between; gap:10px; flex-wrap:wrap">
        <button class="btnDanger" id="btnRangeDelete">Bereich löschen</button>
        <div style="display:flex; gap:10px">
          <button id="btnRangeCancel">Abbrechen</button>
          <button class="btnPrimary" id="btnRangeApply">Speichern</button>
        </div>
      </div>

      <div class="tiny" style="margin-top:10px">
        Hinweis: Urlaub/Krank/Feiertag zählen automatisch als <b>8h</b> (Soll/Tag) an Arbeitstagen.
      </div>
    </div>
  </div>


<script>
  (function(){
    if(!('serviceWorker' in navigator)) return;
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('./sw.js').catch(function(err){
        console.warn('SW register failed', err);
      });
    });
  })();
</script>

</body>
</html>
